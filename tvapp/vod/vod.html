<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <meta name="viewport" content="width=1920" />
    <link rel="stylesheet" href="../public/widgets/page1/page1.css"/>
	<link rel="stylesheet" href="vod.css"/>
<style type="text/css">
.page2 {
	position: absolute;
	width: 1920px; height: 1080px;
}


.mainlist {
	background: url(btn.png) repeat;
	padding-top: 20px;
	padding-left: 20px;
	
}

.mainlist a {
	top: 10px;
	margin: 0px 15px;
	/*padding: 10px;*/
	width: 220px;
	height: 345px;
	overflow: hidden;
	display: inline-block;
	position: relative;
   
}

.mainlist a img {
	padding: 10px 10px;
	position: absolute;
}

.mainlist a span {
	width: 180px;
	margin-left: 10px;
	text-align: center;
	font-size: 30px;
	line-height: 40px;
	display: block;
	height: 40px;
	white-space: nowrap;
    top: 300px;
	position: absolute;
}

.mainlist a:focus,.mainlist a:hover,.mainlist a.currentFocus {
  /*界面列表焦点框*/
	box-shadow :0 0 5px 5px yellow;
	background-color: yellow;
    height: 345px;
	top:0px;
  /*  background-color: yellow;*/
	/*background: url(btnh.png) repeat;*/
}


.mainlist a:focus img.one ,.mainlist a:hover img.one ,.mainlist a.currentFocus img.one {
/*焦点框下图片的变化*/
/*box-shadow:  0 0 5px 5px ;*/  
	padding: 0px;
	width: 220px;
	height: 305px;

}
.mainlist a:focus img.two ,.mainlist a:hover img.two ,.mainlist a.currentFocus img.two {
/*焦点框下图片的变化*/
/*box-shadow:  0 0 5px 5px ;*/  
	display: block;
	width: 65px;
	height: 85px;
	left:150px;
	z-index:2;
	margin-top: -10px;
}
/*
.mainlist a:focus img ,.mainlist a:hover img ,.mainlist a.currentFocus img {

box-shadow:  0 0 5px 5px ;
	padding: 0px;
	width: 220px;
	height: 305px;

}*/

.mainlist a:focus span,.mainlist a:hover span,.mainlist a.currentFocus span {
 /*焦点框下标题变化*/
 /* box-shadow:  0 0 5px 5px red;*/
 top: 310px;
 width: 222px;
 margin-left: 0px;
 color: black;
 background-color:yellow;
text-align: center;
 line-height: 45px;

}

.mainlistpage2 {
	position: absolute;
	top: 955px;
	width: 1770px;
	font-size: 26px;
	text-align: right;
}
.mainlistpage3 {
	position: absolute;
	top: 955px;
	left: 530px;
	width: 200px;
	font-size: 26px;
	text-align: left;
}

.selectMenu {
	color: #d9a007;
}

.one {
	width: 200px;
	height: 285px;
}

.two {
	display: block;
	width: 60px;
	height: 80px;
	left:140px;
	z-index:2;
}

.itemvip {
	display: block;
	position: absolute;
	top: 0;
	left: 0;
	z-index: 2;
}
	.searchpage{
		color: white;
		position: absolute;
		top:120px;
		right:120px;
		font-size: 32px;
		background: #000;
		opacity: 0.8;
		width: 200px;
		height: 80px;
		line-height: 80px;
		text-align: center;
	}

</style>	
</head>
<body>
<div class="page2">
	<img class="logo" id="toplogo" src="mbt.png" style="height: 120px;width: auto;top:10px;" />
	<div class="info">
		<!-- <img id="wifiIcon" src="" /> -->
		<!-- <img src="../public/widgets/page1/vline.png" /> -->
		<span id="dateDiv"></span>
		<span id="timeDiv"></span>
	</div>
</div>

<div class="title"><i id="title"></i></div>
<div class="leftmenu" id="catemenu">
 	<a id="searchBtn" 
 		href="javascript:doSearch();" onfocus="showSearch();" ><img src="cate_search.png" /><i id="isearch">Search</i> </a>
	<a id="favBtn"
		href="javascript:;" onfocus="showFav();" > <img src="cate_fav.png" /><i id="ihistory">History</i></a>
</div>

<div id="mainlist" class="mainlist">
</div>
<div class="mainlistpage2"><i id="listpage"></i></div>
<div class="mainlistpage3"><i id="pagecount"></i></div>
<div id="searchpage" class="searchpage" style="display:none;"></div>
</body>
</html>
<script type="text/javascript" src="../video/public/js/jsget.js"></script>
<script type="text/javascript" src="player/js/key.js"></script>
<script type="text/javascript" src="../video/public/js/config.js"></script>
<script type="text/javascript" src="../../js/auth.js"></script>
<script type="text/javascript" src="../../js/cate.js"></script>
<script type="text/javascript" src="../video/public/js/lang.js"></script>
<script type="text/javascript" src="../public/js/vlist.js"></script>
<script type="text/javascript" src="../public/widgets/list/catemenu.js"></script>
<script type="text/javascript" src="../public/widgets/list/mainlist.js"></script>
<script type="text/javascript" src="../../js/timedate.js"></script>
<script type="text/javascript">
	document.getElementById("isearch").innerText = TR("search");
    document.getElementById("ihistory").innerText = TR("history");

var mid = "";
function querystring(item){
		var svalue = location.search.match(new RegExp("[\?\&]" + item + "=([^\&]*)(\&?)","i"));
		return svalue ? svalue[1] : svalue;
}

var mainlist = new MainList("mainlist", 10);
mainlist.priceFlagHTML = "<img class=\"itemvip\" src='vip.png'/ >";
mainlist.allPage = 0;
mainlist.pageele = document.getElementById("listpage");
mainlist.totalele = document.getElementById("pagecount");

mainlist.onpagechange = function(opage, npage, totalpage, totalCount ) {
	this.allPage = totalpage;
	mainlist.pageele.innerHTML = TR("pages") + npage + "/" + totalpage;
	mainlist.totalele.innerHTML = TR("total") + totalCount;
	this.totalCount = totalCount;
}

mainlist.onnextpage = function() {
	var eles = this.mainEle.getElementsByTagName("a");
	var tEle = eles[0];
	// console.log("onnextpage: cidx " + this.cidx );
	if ( !isNaN(this.cidx) ) {
		var nidx = this.cidx ;
		if ( nidx >= Math.floor(this.pageSize / 2) ) {
			nidx = nidx -  Math.floor(this.pageSize / 2 );
		}
		if ( nidx < eles.length )
			tEle = eles[ nidx ];
	} 

	VatataKeyMove.initById( tEle );
	setTimeout( function(){
		VatataKeyMove.initById( tEle );
	}, 100 );
}

mainlist.onprevpage = function() {
	var eles = this.mainEle.getElementsByTagName("a");
	var tEle = eles[0];
	tEle = eles[ eles.length - 1 ];

	if ( !isNaN(this.cidx) ) {
		var nidx = this.cidx ;
		if ( nidx < Math.floor(this.pageSize / 2) ) {
			nidx = nidx + Math.floor(this.pageSize / 2 );
		}
		if ( nidx < eles.length )
			tEle = eles[ nidx ];
	} 
		// tEle = eles[ Math.floor(this.pageSize / 2) ];	
	VatataKeyMove.initById( tEle );
	setTimeout( function(){
		VatataKeyMove.initById( tEle );
	}, 100 );
}

mainlist.focusItem = function( mid, ele ) {
 var iele = ele.getElementsByTagName("span")[0];
  console.log("focusItem " + mid + " : " + iele.offsetWidth + " : " + iele.scrollWidth  );
  if ( iele.scrollWidth <= iele.offsetWidth ) 
  	return;

  if ( ! ele.textstr )
    ele.textstr = iele.innerHTML.replace(/<[^>]+>/g, "");
         
    //判断是不是阿拉伯文
    var arregex = /[\u0600-\u06FF]/;
    if (arregex.test(ele.textstr)){
       iele.innerHTML = "<marquee direction=\"right\" >" + ele.textstr + "</marquee>";
    }else{
    	iele.innerHTML = "<marquee>" + ele.textstr + "</marquee>";
      
    }
  
}
mainlist.blurItem = function ( mid, ele ) {
  var iele = ele.getElementsByTagName("span")[0];
  if ( ! ele.textstr ) return;

  iele.innerHTML =  ele.textstr ;
}

mainlist.clickItem = function( mid , ele ) {
	var durl = "detail.html?mid=" + mid + "&cate_name=" + catemenu.cat_name + "&cate_id=" + catemenu.all_cid;
	if ( ! this.tvapp ) this.tvapp = wae.create("TvApp");
	this.tvapp.open( durl );
	// location.href = durl;
}

mainlist.getLeftElement = function() {
	return catemenu.currentItem ;
}

var catemenu = new CateMenu( "catemenu", 8 );
catemenu.currentItem = null;
catemenu.show_cid = -1;

catemenu.oncateload = function() {

	var eles = this.menuEle.getElementsByTagName("a");
	var tEle = eles[2];

	var ele = VatataKeyMove.getCurrentEle();

	setTimeout( function(){
		VatataKeyMove.initById( tEle );
		// alert("onver ")
	}, 100 );
	catemenu.currentItem = tEle;

}

catemenu.focusItem = function( cid , ele , idx) {
    mid = cid;
	console.log( "this.cid " + this.cid + " : " + cid );
	if ( this.show_cid == cid ) return;
	this.show_cid = cid;
	console.log( "this.show_cid " + this.show_cid + " : " + cid );

	mainlist.pageload(cid, 1);
	this.currentItem = ele;

	//过滤已收藏节目
	// wae.onResume = checkFav;

    //标记所属主菜单
    var allele = document.getElementsByClassName("selectMenu");
	for( var i=0; !!allele && i<allele.length; i++ ) {
		allele[i].className = allele[i].className.replace( /\s+selectMenu/, "" );
	}
	ele.className = ele.className + " selectMenu";


	if ( idx < 0 ) {
		this.cat_name = "All";
	} else {
		this.cat_name = this.category[idx].cat_name;		
	}

}

catemenu.clickItem = function( cid, ele, idx ) {
	var cate = this.category[idx];
	if ( ! cate ) return;
	if ( ! cate.children ) return;
	if ( ! cate.children.length ) return;

	location.href = "vod.html?acid=" + this.all_cid + "&cid=" + cid + "&catname=" + escape(cate.cat_name) ;
}


catemenu.menuEle['right'] = function() {
	var eles = document.getElementById("mainlist").getElementsByTagName("a");
	return eles[0];
}

var favsession = null;
function checkFav() {
	console.log("check fav ....")
	var cele = VatataKeyMove.getCurrentEle();
	var mid = cele.getAttribute("mid");
	console.log("check fav : current Ele  mid is : " + mid );

	if ( ! favsession ) {
		favsession = wae.create("DATA.Session");
	}

	var isfav = favsession.get("fav_"+mid );
	console.log("check fav is : " + isfav );
	var favicons = cele.getElementsByClassName("two");
	if ( isfav == "fav" ) {
		sessionStorage.setItem( "fav_"+mid , "fav" );
		if ( !!favicons && favicons.length > 0 ) {
			console.log("fav icon is exist , it is ok" );
			return;
		} else {
			//cele.innerHTML = cele.innerHTML + "<img class=\"two\" src='FAV.png'/ >";
			return;
		}
	} else {
		sessionStorage.removeItem( "fav_"+mid  );
		if ( !!favicons && favicons.length > 0 ) {
			console.log("fav icon is exist , it is not ok" );
			favicons[0].outerHTML = "";
			return;
		} else {
			return;
		}

	}
}

window.onWAEReady = function() {
    var param = wae.create("DATA.Parameters");
    var title = param.get("name");
    var apiUrl = param.get("apiUrl");

    if ( !title ) title = "Cinema";
    if ( !apiUrl ) apiUrl = param.get("DATA");

    var res = apiUrl.match(new RegExp("cat_id=(\\d+)","i"));
    var cid = apiUrl;
    if ( res )
      cid = res[1];

  	if ( !!querystring("cid") ) {
  		cid = querystring("cid");
  	}

  	if ( !!querystring("catname") ) {
  		catemenu.title = unescape( querystring("catname") );
  	} else {
  		catemenu.title = "All";
  	}

    document.getElementById("title").innerHTML = TR(title) + " --> " + TR(catemenu.title);
  	if ( !!querystring("acid") ) {
	  	catemenu.all_cid = querystring("acid");
  	} else {
	  	catemenu.all_cid = cid;
  	}
    catemenu.cateload( cid );
    // catemenu.cateload( apiUrl );
    // console.log( "apiurl: " + catemenu.cateList.apiurl );

	var authobj = new Auth();
    authobj.oninitID = function( id ) {
		favList = new Fav( id, cid );
		favList.itemList = new ItemList();
		favList.itemList.onload = (function( list, count, page ) {
			this.onfavload( list, count, page );
		}).bind(favList);

		favList.onfavload = function( list, count, page ) {
			this.list = list;
			var htmlsrc = "";
			for( var j=0; j<list.length; j++ ) {
				/*alert("fav_"+list[j].id)*/
				sessionStorage.setItem("fav_"+list[j].id,"fav");
			}
		}

		favList.itemList.load( favList.getListUrl(), 1,  1000 );

	}
    authobj.initID();

}

function doSearch () {
	setTimeout(function(){
		var res = prompt("Please Input Search Key");
		if( ! res ) return;
		catemenu.show_cid = -2;

		mainlist.searchload( res, catemenu.all_cid );		
		catemenu.currentItem = document.getElementById("searchBtn");
	}, 100);
}

function showFav() {
	catemenu.show_cid = -1;
	mainlist.favload( authobj.getID(), catemenu.all_cid );

	// if ( ! wae.onResume )
	wae.onResume = resetFav;

	var ele = document.getElementById("favBtn");
	catemenu.currentItem = ele;

	var allele = document.getElementsByClassName("selectMenu");
	for( var i=0; !!allele && i<allele.length; i++ ) {
		allele[i].className = allele[i].className.replace( /\s+selectMenu/, "" );
	}
	ele.className = ele.className + " selectMenu";
}

function showSearch() {
	console.log("showSearch ....");
	mainlist.req_cid = "";
	mainlist.mainEle.innerHTML = "";
	var ele = document.getElementById("searchBtn");
	catemenu.currentItem = ele;

	var allele = document.getElementsByClassName("selectMenu");
	for( var i=0; !!allele && i<allele.length; i++ ) {
		allele[i].className = allele[i].className.replace( /\s+selectMenu/, "" );
	}
	ele.className = ele.className + " selectMenu";
}

function resetFav() {
	console.log("check fav ....")
	var cele = VatataKeyMove.getCurrentEle();
	// console.log("check fav : current Ele is: " + cele.outerHTML );
	var mid = cele.getAttribute("mid");
	console.log("check fav : current Ele  mid is : " + mid );

	if ( ! favsession ) {
		favsession = wae.create("DATA.Session");
	}

	var isfav = favsession.get("fav_"+mid );
	console.log("check fav is : " + isfav );
	if ( isfav == "fav" ) {
		return;
	} 

	var favicons = cele.getElementsByClassName("two");
	sessionStorage.removeItem( "fav_"+mid  );
	if ( !!favicons && favicons.length > 0 ) {
		console.log("fav icon is exist , it is not ok" );
		favicons[0].outerHTML = "";


		console.log("check fav : " + catemenu.show_cid  );
		if ( catemenu.show_cid  != -1 ) 
			return;
		// showFav();
		return;
	}
}

mainlist.afterpageload = function() {
	// console.log("check page load after fav : " + catemenu.show_cid  );
	if ( catemenu.show_cid  != -1 ){
	    return;
    }
	var ele = VatataKeyMove.getCurrentEle();
	// console.log("check page load after fav : ele.offsetWidth " + ele.offsetWidth );
	if ( ele.offsetWidth > 0 ) return;
	try {
		// console.log("check page load after fav : ele.offsetWidth " + ele.offsetWidth );
		var itemlist = document.getElementById("mainlist").getElementsByTagName("a");
		// console.log("check page load after fav : itelist " + itemlist.length );
		var item = itemlist[0];
        VatataKeyMove.initByIdIfChanged( item );
		// console.log("check page load after fav : focus " + item.outerHTML );
		return;
	}catch(e){
		console.log("afterpage laod meet: " + e );
	}
	VatataKeyMove.initByIdIfChanged(  mainlist.getLeftElement() );
}

</script>
<script type="text/javascript">


var authobj = new Auth();
authobj.oninitID = function( id ) {
}
authobj.initID();

</script>
<script type="text/javascript">
var file_obj = null;
function setTopLogo( do_update ) {
	var logo_path = localStorage.getItem("logo_path");
	if ( !! logo_path ) {
		var ele = document.getElementById("toplogo");
		//if( !!ele ) ele.src = "file://" + logo_path;
	}

	var bg_path = localStorage.getItem("bg_path");
	if ( !! bg_path ) {
		// var ele = document.getElementById("tvscreen1");
		var ele = document.body;
		if( !!ele ) ele.style.backgroundImage = "url(file://"+bg_path+")";
	}

	if ( do_update == false ) return;

	if ( file_obj == null ) {
	    try {
	      file_obj = wae.create("DATA.File");
	    }catch(e) {
	      setTimeout( function() {setTopLogo( true );}, 1000  );
	      return;
	    }		
	}

	// var path = file_obj.readAll( file_obj.getFilesDir() + "/logo.loc"  );
	// if ( !!path )	localStorage.setItem( "logo_path", path );
	// alert( path );
	path = file_obj.readAll( file_obj.getFilesDir() + "/bg.loc"  );
	if ( !!path )  localStorage.setItem( "bg_path", path );

	setTopLogo( false );
}

setTopLogo( true );


var hotkeys = "";
document.onkeydown = function(e) {
    console.log("pagekey : " + e.keyCode );
    document.getElementById("searchpage").style.display = "block";
    var c = e.keyCode - 48;
    if ( c < 0 || c > 9 ) {
        hotkeys = "";
        document.getElementById("searchpage").style.display = "none";
        return;
    }
    hotkeys += "" + c;

    setTimeout(function () {
        if( parseInt(hotkeys) > parseInt(mainlist.allPage) )  hotkeys = mainlist.allPage +"";
        if( hotkeys !="") 	mainlist.pageload(mid, hotkeys);
        document.getElementById("searchpage").innerText = "";
        document.getElementById("searchpage").style.display = "none";
        hotkeys = "";
        var _tmplist = document.getElementById("mainlist").getElementsByTagName("a");
        setTimeout(function () {
            VatataKeyMove.initById( _tmplist[0] );
        },500);

    }, 1500);
    document.getElementById("searchpage").innerText = hotkeys;
}
</script>
<script type="text/javascript" src="../public/data/statistics.js"></script>
