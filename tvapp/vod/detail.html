<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <meta name="viewport" content="width=1920" />
    <link rel="stylesheet" href="../public/widgets/page1/page1.css"/>
	<link rel="stylesheet" href="vod.css"/>
<style type="text/css">
.page2 {
	position: absolute;
	width: 1920px; height: 1080px;
}

.seriesplayzone {
	border-top: solid white 1px;
	position: absolute;
	width: 1680px;
	height: 260px;
	top: 640px ;
	left: 20px;
	padding: 5px 0;
	overflow: hidden;	
}

.seriesplayzone:before {
	display: block;
	float: left;
	content: "<";
	font-size: 50px;
	width: 30px;
	margin-top: 80px;
	margin-left: 20px;
	transform: scale(1,2);
}

.seriesplayzone:after {
	display: block;
	float: right;
	content: ">";
	font-size: 50px;
	width: 30px;
	margin-top: 80px;
	transform: scale(1,2);
}

.seriesplay2 {
	position: relative;
	display: block;
	float: left;
	width: 1550px;
	height: 260px;
	padding: 20px;
	overflow: hidden;
}


.seriesplay2 a {
	position: relative;
	display: inline-block;
	margin: 10px 10px 10px 15px;
	width: 130px;
	height: 180px;
	overflow: hidden;
}

.seriesplay2 a img {
   position: absolute;
	display: block;
	/*margin-left: 10px;
    margin-top: 10px;*/

}

.seriesplay2 a span {
	display: block;
	font-size: 24px;
	height: 30px;
	line-height: 30px;
	width: 100%;
	overflow: hidden;
	text-align: center;
	position: absolute;
	bottom: 0px;
	background-color: black;
	opacity: 0.7;
}

.seriesplay2 a:focus , .seriesplay2 a.currentFocus {
/*	top: 0px;
	right: 25px;
	margin-right: 20px;
	width: 130px;
	height: 180px;
*/	box-shadow: 0 0 5px 5px yellow;
	/*background-color: #0080ff;*/
}

.titlezone {
	font-size: 60px;
	height: 60px;
	margin-left:200px
}

.storyzone {
	margin-left: 200px;
	margin-top: -40px;
}

.btnlist2 {
	position: absolute;
	top: 500px;
	left: 200px;
	display: none;
}
.btnlist2 a {
	display: inline-block;
	margin: 0px 5px;
	padding: 10px 0;
	width: 200px;
	height: 50px;
	text-align: center;
	background-color:gray;
	font-size: 30px;
	line-height: 50px;
}
.btnlist2 a:hover , .  a:focus, .btnlist2 a.currentFocus {
	background-color: #910a4c;
	/*color: #0080ff;*/
}
.btnlist2 a img {
	height: 40px;
}
.mainpanel2 {
	position: relative;
	top: 125px;
	left: 80px;
	width: 1729px;
	height: 909px;
}
#title{
	height: 100px;
	overflow:hidden;
}
/*.seriesplayzone的log*/
.one{
	width: 100%;
	height: 100%;
}
/*.seriesplayzone上面添加的favorite角标*/
.two{
	display: block;
	width: 60px;
	height: 80px;
	left:70px;
	z-index:2;
}
.starandprice {
	position: absolute;
	top: 0px;
	right: 50px;
	text-align: right;
	display: block;
	font-size: 50px;
	line-height: 50px;
	color: red;
}

.seriesarrow {
	transform: scale(1,2);
}
</style>
</head>
<body>
<div class="">
	<img class="logo" id="toplogo" src="mbt.png" style="height: 150px;width: auto;top:10px;"  />
	<div class="info">
		<span id="dateDiv"></span>
		<span id="timeDiv"></span>
	</div>
</div>
<div class="mainpanel2" >
	<img id="poster" src="" class="vodposter" />

	<div class="starandprice">
		<span id="star"></span>
		<span id="price"></span>
	</div>

	<div class="detailzone">
		<div class=" nalllabel"></div>
		<div id="title" class="allzone titlezone"></div>
		<br />
		<div class=" alllabel"><i id="idirector"></i></div>
		<div id="director" class="about"></div>
		<br />
		<div class=" alllabel"><i id="icast"></i></div>
		<div id="actor" class="about"></div>
		<br />
		<div class=" alllabel"><i id="iinfo"></i></div>
		<div id="info" class="about"></div>
		<br />
		<div class=" alllabel"><i id="istory"></i></div>
		<div id="intro" class="intro storyzone">

		</div>
		<div id="btnlist2" class="btnlist2" style="display: block;">
			<a id="playbtn" href="javascript:;" style="display:block;"
				onclick="mediaItem.play();fav.switch(mediaItem.mid);" class="newbtn"> <i id="iplay"></i> <img src="btn_play.png" />
			</a>
			<a href="javascript:;" class="newbtn" style="display: none;"  id="preview" onclick="mediaItem.preview();">
				<img src="b_rec.png" />
			</a>
			<a href="javascript:;" style="display: none;"
				onclick="fav.switch(mediaItem.mid);" class="newbtn">
				<span id="fav_op" style="display: none;">Fav</span> <img id="favicon" src="b_heart.png" />
			</a>
			<a href="javascript:;" onclick="mediaItem.trailer();"
				class="newbtn" style="display: none">
				TRAILER
			</a>
			<a href="javascript:;" class="newbtn" style="display:none" id="recbtn" onclick="mediaItem.rec();">
				<img src="b_rec.png" />
			</a>
		</div>
	</div>

	<div class="seriesplayzone" id="seriesplayzone">
		<span id="seriesplay" class="seriesplay2">
		</span>
	</div>
	<div id="relatelink" class="relatelink">
	</div>
</div>
</body>
</html>

<script type="text/javascript" src="../video/public/js/jsget.js"></script>
<script type="text/javascript" src="../js/querystring.js"></script>
<script type="text/javascript" src="../video/public/js/config.js"></script>
<script type="text/javascript" src="../../js/cate.js"></script>
<script type="text/javascript" src="../video/public/js/lang.js"></script>
<script type="text/javascript">
	var _idirector,_icast,_iinfo,_istory;
	if( TR("director").length >10) {
        _idirector = "<marquee>"+ TR("director") + "</marquee>";
	} else
	    _idirector = TR("director");

    if(  TR("cast").length >10) {
        _icast = "<marquee>"+ TR("cast") + "</marquee>";
    } else
        _icast = TR("cast");
    if( TR("info").length >10) {
        _iinfo = "<marquee>"+ TR("info") + "</marquee>";
    } else
        _iinfo = TR("info");

    if( TR("story").length >10) {
        _istory = "<marquee>"+ TR("story") + "</marquee>";
    } else
        _istory = TR("story");

	document.getElementById("idirector").innerHTML  = _idirector;
    document.getElementById("icast").innerHTML  = _icast;
    document.getElementById("iinfo").innerHTML  = _iinfo;
    document.getElementById("istory").innerHTML  = _istory;
    document.getElementById("iplay").innerHTML  = TR("play");

function HList( ele, size ) {

	this.init = function(ele, size ){
		this.ele = ele;
		this.size = size;
		this.idx = 0;
		this.itemlist = ele.getElementsByTagName("a");
		for( var i=size; i<this.itemlist.length; i++ ) {
			this.itemlist[i].style.display = "none";
		}
		this.ele['left'] = this.prev.bind(this);
		this.ele['right'] = this.next.bind(this);
	}

	this.prev = function() {
		if ( this.idx <= 0 ) return null;
		this.idx --;
		var first = this.itemlist[ this.idx ];
		first.style.display = "";
		var end = this.itemlist[ this.idx + this.size ];
		if( !! end ) end.style.display = "none";
		return first;
	}

	this.next = function() {
		if ( this.idx + this.size >= this.itemlist.length ) return null;
		var oldfirst = this.itemlist[ this.idx ];
		oldfirst.style.display = "none";
		var end = this.itemlist[ this.idx + this.size ];
		end.style.display = "";
		this.idx ++;
		return end;
	}
	this.init( ele, size);
}
</script>
<script type="text/javascript" src="../../js/timedate.js"></script>
<script type="text/javascript">

function $(id) {
	return document.getElementById(id);
}
var mediatype =null;
var mediaItem = new MediaItem();
mediaItem.authres = null;
mediaItem.onload = function( mInfo , sourceList ) {
    alert(JSON.stringify(mInfo));
	$("title").innerHTML = mInfo.title;
	$("director").innerHTML = mInfo.director;
	$("actor").innerHTML = mInfo.actor;

	/*$("info").innerHTML = mInfo.actor;*/
	$("intro").innerHTML = mInfo.description;
	$("poster").src = mInfo.imgAddress;

	if ( mInfo.price > 0 ) {
		$("price").innerHTML = "$" + mInfo.price;
	}	

	var min = !mInfo.duration? "**": mInfo.duration;
	var style= !mInfo.style ? "**" : mInfo.style;
	var playtime = !mInfo.playtime ? "**": mInfo.playtime;
	var productarea =!mInfo.productarea ? "**" : mInfo.productarea;
	if(playtime==""||playtime==null){
        playtime="";
	}

    var infostr = min+"min <img src=\"../public/widgets/page1/vline.png\" height=\"25\"> "+style+" <img src=\"../public/widgets/page1/vline.png\" height=\"25\"> "+playtime+
    " <img src=\"../public/widgets/page1/vline.png\" height=\"25\"> ("+productarea+")"
    // alert( infostr )
    $("info").innerHTML = infostr;

	var star_html = "";
	var star_num = parseInt( mInfo.star );
	if ( ! isNaN(star_num) ) {
		for( var i=0; i<star_num; i++  ) star_html += '<img src="star.png" />';
		if ( parseFloat(mInfo.star) > (star_num + 0.1) ) star_html += '<img src="star2.png" />';		
	}

	$("star").innerHTML = star_html;

	try{
		var volsrc = "";
		var volumes = this.sourceList[0].volumes;
		//加载电视剧
		if( !!volumes && !!volumes.length && volumes.length > 0 ) {
			mediatype =volumes;
			for( var j=0; j<volumes.length; j++ ) {
			    // volumes[j].name
				// var tmp = volumes[j].name.replace(/[^0-9]/ig,"")
				var t = "";
				// if( volumes.length > 10 && volumes.length <100) {
				//     if( tmp<10) t = "0"+ tmp;
				//     else t = tmp;
				// } else if(volumes.length >100) {
				//     if(tmp <10 ) t = "00" +tmp;
				//     else if(tmp>10 && tmp<100) {
                //         t = "0" +tmp;
				// 	} else {
				//         t = tmp;
				// 	}
				//
				// }
				t = volumes[j].name;
				volsrc += '<a href="javascript:;" onclick="mediaItem.playSeries('+j+');fav.switch(mediaItem.mid);" >'
				+ "<img width='130px' height='182px' src='"+ mInfo.imgAddress +"' onerror='this.style.visibility=\"hidden\";'/><span>"+  t +"</span></a>"
			}
			document.getElementById("playbtn").style.display = "none";
			// document.getElementById("recbtn").style.display = "none";
			document.getElementById("btnlist2").style.display = "block";
			$("seriesplay").innerHTML = volsrc;

			var hlist = new HList($("seriesplay"), 10 );
			VatataKeyMove.initById( $("seriesplay").getElementsByTagName("a")[0] );			
		} else {
			document.getElementById("playbtn").style.display = "inline-block";
			document.getElementById("btnlist2").style.display = "block";
			mediatype ="movie";
			VatataKeyMove.initById("playbtn");
		}
	}catch(e){ console.log("meet ex: " + e);}


	setTimeout( function() {
		alert("power : " + mInfo.power );
		authobj.onauth= function(is_ok, res ) {
			console.log("auth checkpower: " + is_ok + " : " )
			mediaItem.authres = is_ok ;
		}
		authobj.check( mInfo.power );
	}, 100 );
}

mediaItem.select = function( mid ) {
	location.replace( "detail.html?mid=" + mid );
}

mediaItem.callplay = function( url, title,pid ) {
    var tvappobj = wae.create("TvApp");
    tvappobj.putExtra("URLS", url);
    tvappobj.putExtra("title", title );
    tvappobj.putExtra("pid", pid );
    tvappobj.putExtra("volumes", -1);
    //this.tvappobj.putExtra("volumes", JSON.stringify(volumes));
    //this.tvappobj.putExtra("vindex", idx );
    tvappobj.start( "player/player.html");
}

mediaItem.preview = function() {
    var title = mediaItem.mediaInfo.title;
    var url = mediaItem.mediaInfo.urlAddress;
    var tvappobj = wae.create("TvApp");
    // url = "http://tv.tvata.com:8078/streams/vod/x.flv";
    tvappobj.putExtra("URLS", url);
    tvappobj.putExtra("title", title );
    tvappobj.putExtra("volumes", -1);
    //this.tvappobj.putExtra("volumes", JSON.stringify(volumes));
    //this.tvappobj.putExtra("vindex", idx );
    tvappobj.start( "player/preview.html");
}
mediaItem.play = function() {
	console.log("media play ...");
	if ( mediaItem.authres == null ) {
		// // console.log("no auth response ");
		alert("The server no response to playing request, please wait!");
		return;
	}

	console.log("media play ..."  +  mediaItem.authres );

	if( mediaItem.authres == true ) {
		var url = mediaItem.mediaInfo.urlAddress;
		var title = mediaItem.mediaInfo.title;
        var pid = mediaItem.mediaInfo.autoid;
		mediaItem.callplay( url, title,pid );
		return ;
	}

	var mInfo = mediaItem.mediaInfo;
	var price = parseInt(mInfo.price);
	var validday = parseInt(mInfo.validday );
    window.location.href = "../activation/code.html";
    return;
	if ( !isNaN(price) && price > 0 ) {

	    window.location.href = "../activation/code.html";
	    return;
		var key = "paytime_" +  mInfo.autoid;
		var paytime = localStorage.getItem(key );

		if ( !! paytime ) {
			var paysec = parseInt( paytime );
			var now  = (new Date()).getTime() / 1000 ;
			var paydays = Math.floor(( now - paysec ) / 3600 / 24 );

			if ( paydays <= validday ) {
				mediaItem.authres = true;
				return setTimeout( mediaItem.play.bind(mediaItem), 100 );
			} 
			localStorage.removeItem("paytime_" +  mInfo.autoid );
		}
		var r = confirm( "You need pay $" + price + " to watch the video, pay for it?");

		if ( r ) {
			return mediaItem.pay();
		}
	} else {
        var url = mediaItem.mediaInfo.urlAddress;
        var title = mediaItem.mediaInfo.title;
        var pid = mediaItem.mediaInfo.autoid;
        mediaItem.callplay( url, title,pid );
        return ;
	}
	// alert( "Access Denied!");
}

mediaItem.pay = function() {
	var mInfo = mediaItem.mediaInfo;

	var mid = mInfo.autoid;
	var did = authobj.getID();

	var payobj = new PayAPI();
	payobj.onload = function( result ) {
		if ( ! result ) {
			alert( "Pay Failed!");
			return;
		}
		if ( result.code != 200 && result.code != 1 ) {
			alert("Pay Failed, Please check your balance!");
			// alert( result.msg );
			return;
		}

		alert( "payment success!");

		var key = "paytime_" +  mInfo.autoid;
		var now = Math.ceil((new Date()).getTime() / 1000) ;
		localStorage.setItem( key , now);

		mediaItem.play();
	}

	payobj.pay( did, mid );
}

mediaItem.paySeries = function() {
	var mInfo = mediaItem.mediaInfo;

	var mid = mInfo.autoid;
	var did = authobj.getID();

	var payobj = new PayAPI();
	payobj.onload = function( result ) {
		if ( ! result ) {
			alert( "Pay Failed!");
			return;
		}
		if ( result.code != 200 && result.code != 1 ) {
			alert("Pay Failed, Please check your balance!");
			// alert( result.msg );
			return;
		}

		alert( "payment success!");

		var key = "paytime_" +  mInfo.autoid;
		var now = Math.ceil((new Date()).getTime() / 1000) ;
		localStorage.setItem( key , now);

		mediaItem.playSeries();
	}

	payobj.pay( did, mid );	
}

mediaItem.currentIdx = 0;
mediaItem.media_url = SERVER_URL.replace(":16310","8278/streams/video");
mediaItem.playSeries = function( idx ) {

	if ( isNaN( idx ) ) {
		idx = mediaItem.currentIdx;
	}
	mediaItem.currentIdx = idx;
	if ( mediaItem.authres == null ) {
		// alert("Please wait server's response!");
		// return;
	}

	if( mediaItem.authres != true ) {
		var mInfo = mediaItem.mediaInfo;
		var price = parseInt(mInfo.price);
		var validday = parseInt(mInfo.validday );

		if ( !isNaN(price) && price > 0 ) {
			var key = "paytime_" +  mInfo.autoid;
			var paytime = localStorage.getItem(key );

			if ( !! paytime ) {
				var paysec = parseInt( paytime );
				var now  = (new Date()).getTime() / 1000 ;
				var paydays = Math.floor(( now - paysec ) / 3600 / 24 );

				if ( paydays <= validday ) {
					mediaItem.authres = true;
					return setTimeout( mediaItem.playSeries.bind(mediaItem), 100 );
				} 
				localStorage.removeItem("paytime_" +  mInfo.autoid );
			}
			var r = confirm( "You need pay $" + price + " to watch the video, pay for it?");

			if ( r ) {
				return mediaItem.paySeries();
			}
		}
	}

	this.media_url = SERVER_URL.replace("16310","8728/streams/video");
	console.log("play serires " + idx );
	var volumes = this.sourceList[0].volumes;
	var info = volumes[idx];
	var url = info.urla;
	var pid = info.id;
	if(url.indexOf("http") <0 ) {
        url = this.media_url + "" + url;
	}

	var title = mediaItem.mediaInfo.title;
	wae.onResume = function() {
		setTimeout( function() {
			var complete_url = localStorage.getItem("complete_url");
			if ( ! complete_url ) return;

			var next = mediaItem.currentIdx + 1 ;
			if ( next >= mediaItem.sourceList[0].volumes.length )
				return;

			mediaItem.playSeries( next );			
		}, 1000 * 2);
	}

    var tvappobj = wae.create("TvApp");
    tvappobj.putExtra("URLS", url);
    tvappobj.putExtra("title", title );
    tvappobj.putExtra("pid", pid);
    tvappobj.putExtra("volumes", JSON.stringify(volumes));
    tvappobj.putExtra("vindex", idx );
    tvappobj.start( "player/player.html");
	return;
	//mediaItem.callplay( url, title );
}

mediaItem.mid = Request.q("mid");
mediaItem.load( mediaItem.mid );


mediaItem.trailer = function() {
	// alert( JSON.stringify( mediaItem.mediaInfo ) );
	var url = mediaItem.mediaInfo.trailer;

	if ( !url || url.length < 5  ) {
		alert("No TRAILER for the video!");
		return;
	}
	var title = mediaItem.mediaInfo.title;
	var pid = mediaItem.mediaInfo.autoid;
	mediaItem.callplay( url, title,pid );
}

mediaItem.rec = function() {
	// alert("recording")
}

</script>
<script type="text/javascript" src="../../js/auth.js"></script>
<script type="text/javascript">

var fav = null;

// var cid = sessionStorage.getItem("CAT_ID");
var cid = Request.q("cate_id");
if ( isNaN(cid) ) cid = 1;

var authobj = new Auth();
authobj.oninitID = function( id ) {
	fav = new Fav( id, cid );
	fav.oncheck = function( is_fav ) {
		// alert( is_fav );
		$("fav_op").innerHTML = is_fav ? "Del" : "Add";
		$('favicon').src = is_fav == false ? "b_heart.png" : "b_heartd.png";

		console.log("oncheck change fav status: " + mediaItem.mid + " is " + is_fav );
		if ( ! fav.session ) {
			fav.session = wae.create("DATA.Session");
		}
		if ( is_fav && !!fav.session ) {
			fav.session.put("fav_"+mediaItem.mid,"fav");
		}
		else {
			fav.session.remove("fav_"+mediaItem.mid);			
		}
	}
	fav.check( mediaItem.mid );

	fav.itemList = new ItemList();
	fav.itemList.onload = (function( list, count, page ) {
		//设置时间给mediatype赋值 避免mediatype=null执行fav.onfavload 
		setTimeout(this.onfavload( list, count, page ),1000);
	}).bind(fav);


    //加载电影
	fav.onfavload = function( list, count, page ) {
		 if( mediatype=="movie" ) {
	
		// alert("FavList: " + JSON.stringify(list) );
		this.list = list;
		var htmlsrc = "";
		for( var j=0; !!list && j<list.length; j++ ) {
			htmlsrc += '<a href="javascript:;" onclick="favonloaw('+list[j].id+');" >'
				+ "<img  class=\"one\" src='"+ list[j].logo +"' onerror='this.style.visibility=\"hidden\";' /><span>"
				+  list[j].name + "</span>"
                + "<img class=\"two\" src='FAV.png'/></a>";
		}
		document.getElementById("seriesplay").innerHTML = htmlsrc;
	}
		// var volumes = this.sourceList[0].volumes;
		// alert(volumes.length);
		// if( !!volumes && !!volumes.length && volumes.length > 0 ) {
		// 	document.getElementById("seriesplay").innerHTML = htmlsrc;
		// 	document.getElementById("seriesplay").style.display = "block";
		// 	document.getElementById("relatelink").style.display = "none";
		// } else {
		// 	document.getElementById("relatelink").innerHTML = htmlsrc;
		// 	document.getElementById("relatelink").style.display = "block";
		// 	document.getElementById("seriesplay").style.display = "none";
		// }
		var hlist = new HList($("seriesplay"), 10 );
	}
    
	fav.itemList.load( fav.getListUrl(), 1,  1000 );
}

authobj.initID();

</script>
<script type="text/javascript" src="player/js/key.js"></script>


<script type="text/javascript">

 //点击收藏电影页面重新加载
function favonloaw(mid){
	var cat_name = Request.q("cate_name");
	var cate_id = Request.q("cate_id");
	var durl = "detail.html?mid=" + mid + "&cate_name=" + cat_name + "&cate_id=" +cate_id;
       location.replace(durl);

}
var file_obj = null;
function setTopLogo( do_update ) {
	var logo_path = localStorage.getItem("logo_path");
	if ( !! logo_path ) {
		var ele = document.getElementById("toplogo");
		//if( !!ele ) ele.src = "file://" + logo_path;
	}

	var bg_path = localStorage.getItem("bg_path");
	if ( !! bg_path ) {
		// var ele = document.getElementById("tvscreen1");
		var ele = document.body;
		if( !!ele ) ele.style.backgroundImage = "url(file://"+bg_path+")";
	}

	if ( do_update == false ) return;

	if ( file_obj == null ) {
	    try {
	      file_obj = wae.create("DATA.File");
	    }catch(e) {
	      setTimeout( function() {setTopLogo( true );}, 1000  );
	      return;
	    }		
	}

	path = file_obj.readAll( file_obj.getFilesDir() + "/bg.loc"  );
	if ( !!path )  localStorage.setItem( "bg_path", path );

	setTopLogo( false );
}

setTopLogo( true );
	
</script>
<script type="text/javascript">
	


// const PAY_URL = SERVER_URL + 'index.php/localboss/api/ purchase_movie/device_id/movie_id';
const PAY_URL = SERVER_URL + 'index.php/localboss/api/purchase_movie/';


function PayAPI( ) {

	this.onload = function( result ) {
	}

	this.pay = function(did, mid ) {
		this.did = did;
		this.mid = mid;
		var uget = new EasyGet();
		uget.onsuccess = (function(u,d) {
			// alert( u + "\n" + d );
			var _ugetdata = null;
			try{
				eval( '_ugetdata  = ' + d );
			}catch(e){ }
			this.onload( _ugetdata );
		}).bind(this);
		uget.onerror = (function(e) {
			this.onload( null );
		}).bind(this);
		this.payurl = PAY_URL + this.did + "/" + this.mid ;
		// console.log( "payurl: " + this.payurl );
		uget.open( this.payurl, true);
	}
}


</script>
