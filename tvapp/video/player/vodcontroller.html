<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1920,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>播放控制条</title>
<style>
body {
    background: transparent;
    width: 1920px;
    height: 1080px;
    overflow: hidden;   
}
.dr {
    border: solid 1px red;
}
.bottombar {
    position: absolute;
    top: 810px;
    left: 0px;
    width: 1920px;
    height: 180px;
    overflow: hidden;
    background-color: black;
    opacity: 0.5;
    font-size: 30px;
    color: white;
}

.msgbar {
    position: relative;
    width: 100%;
    height: 60px;
    line-height: 60px;
    font-size: 30px;
}

.msgbar span {
    float: left;
    display: block;
    margin: 0 30px;
}

.msgbar div {
    float: right;
    display: block;
    margin: 0 30px;
}

.seekbar {
    position: relative;
    margin: 5px 60px;
    color: white;
    width: 1800px;
    padding-top: 5px;
    overflow: hidden;
}
.seekbar span {
    display: inline-block;
    overflow: hidden;
    vertical-align: top;
    font-size: 30px;
}
.playtime  {
    width: 150px;
    text-align: right;
}
.endtime {
    width: 120px;
    text-align: left;
}
.seekbarbg {
    width: 1500px;
    height: 30px;
    margin-top: 10px;
    border-top: solid 5px white;
}

.seekbarpointer {
    position: absolute;
    width: 24px;
    height: 24px;
    margin-top: -15px;
    background-color: #999;
    border-radius: 15px;
    overflow: hidden;
}

.btns {
    text-align: center;
    position: relative;
}

.btns a {
    display: inline-block;
    width: 120px;
    height: 60px;
    overflow: hidden;
    color: white;
    line-height: 60px;
}

.btns a div {
    display: inline-block;
    color: white;
    padding: 0 20px;
}


a:focus {
    outline: none;
    text-decoration: none;
}
a:link {
    outline: none;
    text-decoration: none;    
}

.btns a:focus , .btns a.currentFocus {
}

.btns a:hover img, .btns a:focus img , .btns a.currentFocus img {
    border: solid 1px #bbb;
    background-color: #bbb;
}

.btns a img {
    vertical-align: middle;
    padding: 5px 20px;
    border: solid 1px transparent;
}

</style>

</head>
<body class="" >
    <div id="bottombar" class="bottombar" >
        <div class="msgbar">
            <span id="playtitle">loading...  </span>
            <div id="netspeed"></div>
        </div>
        <div class="seekbar">
            <span id="playtime" class=" playtime" > &nbsp; </span>
            <span id="seekbar" class=" seekbarbg">
                <div id="seekpointer" class=" seekbarpointer"> </div>
            </span>
            <span id="duration" class=" endtime" > &nbsp; </span> 
        </div>
        <div class="btns">
            <a style="display:none;" id="btnprevep"
                onfocus="btnprev.src='btnimage/iprevh.png';"
                onblur="btnprev.src='btnimage/iprev.png';"
                href="javascript:;" onclick="playprev();" ><img id="btnprev" src="player/btnimage/iprev.png"/></a>
            <a 
                onfocus="btnback.src='btnimage/ibackh.png';"
                onblur="btnback.src='btnimage/iback.png';"
                href="javascript:;" onclick="seekback();" ><img id="btnback" src="../video/player/btnimage/iback.png"/></a>
            <a  id="btnfirst" 
                onfocus="btnplay.src='btnimage/iplayh.png';"
                onblur="btnplay.src='btnimage/iplay.png';"
                href="javascript:;" onclick="playpause();"><img id="btnplay" src="../video/player/btnimage/iplay.png"/></a>
            <a 
            	onfocus="btnfwd.src='btnimage/ifwdh.png';"
            	onblur="btnfwd.src='btnimage/ifwd.png';"
                href="javascript:;" onclick="seekfwd();"><img id="btnfwd" src="../video/player/btnimage/ifwd.png"/></a>
            <a style="display:none;" id="btnnextep"
                onfocus="btnnext.src='btnimage/inexth.png';"
                onblur="btnnext.src='btnimage/inext.png';"
                href="javascript:;" onclick="playnext();"><img id="btnnext" src="player/btnimage/inext.png"/></a>
        </div>
    </div>
</body>
</html>

<script type="text/javascript">

function formatTime(ms) {
    if ( ms < 0 ) return "00:00";

    var s = Math.floor(parseInt(ms)/1000) % 60;
    if( s < 10 ) s = "0" + s ;
    else s = "" + s;

    var m = Math.floor(parseInt(ms)/1000/60 ) %60;
    if( m<10 ) m = "0" + m;
    else m = "" + m;

    var h = Math.floor(parseInt(ms)/1000/60/60 ) %24;
    if( h == 0 ) return m + ":" + s;

    return h+":"+m+":"+s; 
}

var eventobj = null;
var mainwin = null;

var volumeInfo = null;
var title = "";
var showtitle = "";

var e_title = document.getElementById("playtitle");

var e_bottombar = document.getElementById("bottombar");
var e_duration = document.getElementById("duration");
var e_playtime = document.getElementById("playtime");
var e_seekbar = document.getElementById("seekbar");
var e_seekpointer = document.getElementById("seekpointer");
var e_netspeed = document.getElementById("netspeed");


var btn_prevep = document.getElementById("btnprevep");
var btn_nextep = document.getElementById("btnnextep");


var btnback = document.getElementById("btnback");
var btnfwd = document.getElementById("btnfwd");
var btnplay = document.getElementById("btnplay");
var btnnext = document.getElementById("btnnext");
var btnprev = document.getElementById("btnprev");


var maxwidth = e_seekbar.offsetWidth - e_seekpointer.offsetWidth;
var oleft = e_seekbar.offsetLeft;
var duration;
var playtime;
var in_seek = false;
var epsoideInfo = null;

function uni_onready(){
    var uiSettings = wae.create("UI.UISettings");
    uiSettings.set1080P();

    // eventobj = wae.create("RawKey");
    // console.log("video player hold all key!")
    // eventobj.onKeyEvent = function( a ) {
    //     if( a.arguments[0] == 4 ) {
    //         var fwin = wae.create("UI.WaePopupWebView");
    //         fwin.removeWebView("controller");
    //         console.log("close player ! ");
    //     }
    // }
    // eventobj.add(4);
    // eventobj.add_default_key();

    //rawkeyobj = wae.create("RawKey");
    // rawkeyobj.add_default_key();

    mainwin = wae.create("WAE.WindowMessager");
    mainwin.setName( "controller" );
    mainwin.onUpdate = function(e) {
        if ( in_seek ) return;
        //console.log("on update ...")
        try {
            eval("var info = " + e.arguments );
            duration = info.duration;
            playtime = info.playtime;

            e_duration.innerHTML = formatTime ( duration );
            e_playtime.innerHTML = formatTime ( playtime );

            var left = Math.floor( playtime * maxwidth / duration ) + oleft;
            e_seekpointer.style.left = left + "px";
        }catch(e){}
    }
    mainwin.onCompletion = function() {
                // eventobj.holdKey( false );
        if ( playnext() == true ) 
            return;

        console.log("playover all epsoide, stop ");
        stop();
        // mainwin.sendMessage("main", "hide", "" );         
    }

    mainwin.onSetTitle = function( p ) {
        // alert( JSON.stringify(p) );
        title = p.arguments[0];
        showtitle = title;
        // console.log("set the title!");
        e_title.innerHTML = showtitle;        
    }
    mainwin.onSetVolumeInfo = function( p ) {
        // console.log( "SetVolumeInfo : " + JSON.stringify(p) );
        volumeInfo = JSON.parse( p.arguments[0] );
        // console.log( "SetVolumeInfo : " + JSON.stringify(volumeInfo) );
        if ( ! volumeInfo ) return;
        
        resetEpBtn();

        var vindex = volumeInfo.index;
        var showtitle = title + " - " + volumeInfo.volumes[vindex].name;
        // console.log( "SetVolumeInfo : " + showtitle + " : " + e_title.innerHTML );
        e_title.innerHTML = showtitle;        
        // console.log( "SetVolumeInfo2 : " + showtitle );
    }

    mainwin.onBuffer = function( p ) {
        var rate = p.arguments[0];
        if ( isNaN(rate) || rate == 100 ) {
        	console.log("");
            e_title.innerHTML = showtitle ;
        } else {
            showNetSpeed();
        }
    }

    mainwin.onStartplay = function(playinfostr) {
        console.log("onStartplay")
        var playinfo = JSON.parse( playinfostr.arguments[0] ); // JSON.parse( playinfostr );
        if ( ! playinfo ) return;

		//alert( playinfo );
		//document.getElementById("playtitle").innerHTML = epsoideInfo.title;
    }

    updatetitle();

    hotKey.init();
}

function showNetSpeed() {
    var speedstr = "";
    if( ! mainwin.speedobj ) {
        mainwin.speedobj = wae.create("Net.NetSpeed");
        mainwin.speedobj.setTotalMode( true );
        mainwin.speedobj.resetSpeed();          
    } else {
        var s = mainwin.speedobj.getDownloadSpeed();
        // console.log("getDownloadSpeed : " + s );
        s = Math.floor( s * 8 * 10 )/10;
        if ( s > 1000 ) {
            speedstr = ( Math.floor(s/100)/10 ) + "mbps";
        } else if ( s > 0 ) {
            speedstr = (s)  + "kbps";
        } else {
            speedstr = "";
        }
    }

    if ( !! speedstr )
        e_netspeed.innerHTML =  speedstr ; 
    else
        e_netspeed.innerHTML = "" ;
}

function showNetSpeedOnSec() {
    // console.log( "showNetSpeedOnSec " );
    if ( !! showNetSpeedOnSec.timer ) 
        clearTimeout( showNetSpeedOnSec.timer );
    
    // console.log( "showNetSpeedOnSec " + hasShow() );
    if ( hasShow() == false ) {
        showNetSpeedOnSec.timer = null;
        e_netspeed.innerHTML = "" ;
        return;    
    } 
    showNetSpeedOnSec.timer = setTimeout( showNetSpeedOnSec, 1000 );

    showNetSpeed();
}

function resetEpBtn() {
    if ( ! volumeInfo ) {
        btn_prevep.style.display = "none";
        btn_nextep.style.display = "none";
    } else if ( volumeInfo.index <= 0 ) {
        btn_prevep.style.display = "none";
        btn_nextep.style.display = "inline-block";        
    } else if ( volumeInfo.index >= volumeInfo.volumes.length -1 ) {        
        btn_prevep.style.display = "inline-block";
        btn_nextep.style.display = "none";        
    } else {
        btn_prevep.style.display = "inline-block";
        btn_nextep.style.display = "inline-block";        
    }
}

function playnext() {
    if ( ! volumeInfo ) return false;
    var idx =  volumeInfo.index + 1 ;
    if ( idx >= volumeInfo.volumes.length )  return false;
    e_title.innerHTML = "Loading..." ; 
    mainwin.sendMessage("main", "PlayEpsiode", idx );
    return true;
}

function playprev() {
    if ( ! volumeInfo ) return false;
    var idx = volumeInfo.index  - 1;
    if ( idx < 0 )  return false;
    e_title.innerHTML = "Loading..." ; 
    mainwin.sendMessage("main", "PlayEpsiode", idx );
    return true;
}

function updatetitle() {
    mainwin.sendMessage("main", "updatetitle", "" );
}

function playpause() {
    // console.log("playpause: " + hasShow() );
    // if ( hasShow() == false ) return;
    // console.log("before send playpause ....");
    mainwin.sendMessage("main", "playpause", "" );
}

function stop() {
    // console.log("stop: " + hasShow() );
    // if ( hasShow() == false ) return;
    // console.log("before send playpause ....");
    // mainwin.sendMessage("main", "stop", "" );

    var app = wae.create("Application");
    app.finishActivity();
}

function play() {
    console.log("play: " + hasShow() );
    if ( hasShow() == false ) return;
    // console.log("before send playpause ....");
    mainwin.sendMessage("main", "play", "" );
}

function pause() {
    console.log("pause: " + hasShow() );
    if ( hasShow() == false ) return;
    // console.log("before send playpause ....");
    mainwin.sendMessage("main", "pause", "" );
}

function seek( ms ) {
    if ( hasShow() == false ) return;
    //console.log("seek to " + ms);
    //if ( hasShow() == false ) return;
    console.log("seek to " + ms);
    mainwin.sendMessage("main", "seek", ms );
}

var seektimer = null;
var s_playtime = -1;
var seek_step_min = 5 * 1000;
var seek_step_max = 30 * 1000;
var seek_step = seek_step_min;

function seekfwd() {
    console.log("seekfwd ::::: s_playtime : " + s_playtime );
    // if ( hasShow() == false ) return;
    in_seek = true;

    mainwin.sendMessage("main", "pause", "" );

    if( s_playtime == -1 ) {
        s_playtime = playtime;
        seek_step = seek_step_min;
    } else {
        seek_step = seek_step_max;
    }
    if ( s_playtime  + seek_step >= duration ) {
        seek_step = seek_step_min;
    }
    s_playtime = s_playtime + seek_step;
    if ( s_playtime  + seek_step >= duration ) {
        s_playtime = duration - seek_step ; 
    }
    if( s_playtime < 0 ) {
        s_playtime = 0;
    }
    
    var left = Math.floor( s_playtime * maxwidth / duration ) + e_seekbar.offsetLeft;
    e_seekpointer.style.left = left + "px";

    if( !!seektimer ) clearTimeout( seektimer );
    seektimer = setTimeout(function(){
        in_seek = false;
        seek( s_playtime );
        s_playtime = -1;
    }, 1000 * 2 );
}
function seekback() {
    console.log("seekback:::: " + hasShow() );
    // if ( hasShow() == false ) return;
    in_seek = true;
    mainwin.sendMessage("main", "pause", "" );

    if( s_playtime == -1 ) {
        s_playtime = playtime;
        seek_step = seek_step_min;
    } else {
        seek_step = seek_step_max;
    }

    if ( s_playtime  - seek_step <= 0 ) {
        seek_step = seek_step_min;
    }

    s_playtime = s_playtime - seek_step;
    if ( s_playtime  + seek_step >= duration ) {
        s_playtime = duration - seek_step ; 
    }
    if( s_playtime < 0 ) {
        s_playtime = 0;
    }
    var left = Math.floor( s_playtime * maxwidth / duration ) + e_seekbar.offsetLeft;
    e_seekpointer.style.left = left + "px";

    console.log("seek to  " + s_playtime );
    if( !!seektimer ) clearTimeout( seektimer );
    seektimer = setTimeout(function(){
        in_seek = false;
        seek( s_playtime );
        s_playtime = -1;
    }, 1000 * 2);
}

window.onWAEReady = uni_onready;  

</script>
    
<script type="text/javascript" src="player/js/key.js"></script>
<script type="text/javascript">

var hidden_timer = null;
var hidden_ms = 1000 * 10;

function hideBar() {
    console.log("hideBar ... ");
    if( !!hidden_timer ) clearTimeout( hidden_timer );
    if ( e_bottombar == null ) return;
    e_bottombar.style.display = "none";
}
function resetShowBar() {
    if( !!hidden_timer ) clearTimeout( hidden_timer );
    hidden_timer = setTimeout( hideBar, hidden_ms );    
}
var isShowingBar = false;
function showBar() {
    if( !!hidden_timer ) clearTimeout( hidden_timer );
    if ( e_bottombar == null ) return;

    hidden_timer = setTimeout( hideBar, hidden_ms );
    e_bottombar.style.display = "block";
    isShowingBar = true;
    setTimeout( function() {
        VatataKeyMove.initById("btnfirst");
    }, 100 );
    setTimeout( function() {
        isShowingBar = false;
        showNetSpeedOnSec();
    }, 200 );
}

function hasShow() {
    if ( e_bottombar.style.display == "block" ) {
        if ( isShowingBar == false )
            return true;  
    } 
    return false;
}

// hideBar();
    // document.getElementById("bkimg").style.display = "none";

showBar();

document.body.onclick = function() {
    if ( hasShow() )
        return resetShowBar();
    showBar();
}

document.onkeydown = function(e) {
    //console.log("onkeydown: " + e.keyCode );
    if ( hasShow() == false ) {
        setTimeout(showBar, 100 );
        return;
    } else {
        resetShowBar();
    }

    switch( e.keyCode ) {
         case 83:
         setTimeout(hideBar, 100 );
        //     console.log("get comm for next");
        //     mainwin.sendMessage("main", "next", "" );
         break;
        // case 87:
        //     console.log("get comm for prev");
        //     mainwin.sendMessage("main", "prev", "" );
        // break;
        // case 65:
        //     prev();
        //     break;
        // case 68:
        //     next();
        //     break;
        // case 70:
        //     playpause();
        //     break;
    }
}



  const SYS_KEY_PLAY = 85;
  const SYS_KEY_STOP = 86;


  const SYS_KEY_RED = 131;
  const SYS_KEY_YELLOW = 133;
  const SYS_KEY_GREEN = 132;

  const SYS_KEY_NEXT = 90;
  const SYS_KEY_PREV = 89;

  const SYS_KEY_PAUSE = 139;

  const SYS_KEY_BACK = 4;
  const SYS_KEY_ESC = 111;
  function hotKey() {
  }

  hotKey.init = function() {
    var eventListener = wae.create("EventListener");
    eventListener.addJs( SYS_KEY_PLAY,   "hotKey.play();" );
    eventListener.addJs( SYS_KEY_PAUSE,  "hotKey.pause();" );
    eventListener.addJs( SYS_KEY_STOP ,  "hotKey.stop();");
    eventListener.addJs( SYS_KEY_GREEN,  "hotKey.seekfwd();" );
    eventListener.addJs( SYS_KEY_RED,    "hotKey.red();" );
    eventListener.addJs( SYS_KEY_NEXT,   "hotKey.seekfwd()" );
    eventListener.addJs( SYS_KEY_PREV,   "hotKey.seekback()" );

    eventListener.addJs( SYS_KEY_BACK,   "hotKey.exit()" );
    eventListener.addJs( SYS_KEY_ESC,    "hotKey.exit()" );

    hotKey.toast = wae.create("Toast");
  }
  hotKey.exit = function() {
    if ( !! hotKey.backcount && hotKey.backcount > 0 ) {
        hotKey.stop();
        return;
    }
    if ( ! hotKey.backcount ) hotKey.backcount = 1;
    else hotKey.backcount ++;

    console.log("Press back again to exit");
    hotKey.toast.setEnable(true);
    hotKey.toast.showMessage("Press back again to stop playing!");
    setTimeout( function(){
        hotKey.backcount = 0;
    }, 1000 *5 );
  }
  hotKey.play = function() {
    showBar();
    playpause();
  }
  hotKey.pause = function() {
    showBar();
    pause();
  }

  hotKey.playpause = function() {
    showBar();
    playpause();
  }
  hotKey.stop = function() {
    // showBar();
    stop();
  }
  hotKey.seekfwd = function() {
    showBar();
    seekfwd();
  }
  hotKey.seekback = function() {
    showBar();
    seekback();
  }
  hotKey.red = function() {
    hideBar();
  }
  hotKey.screendn = function() {
  }


</script>
