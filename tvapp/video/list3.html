<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Movie List</title>
    <meta name="viewport" content="width=1920" />
    <link rel="stylesheet" href="../message/public.css"/>
    <link rel="stylesheet" href="../video/css/movie.css"/>
    <style type="text/css">
        .tvtitle {

        }

        .tvlist {
            width: 1380px;
            height: 350px;
            overflow: hidden;
        }

        .movielist {
            position: relative;
            overflow: hidden;
            height: 350px;
            margin-left: 20px;
        }
        .movielist a {
            float: left;
            display: block;
            text-align: center;
            width: 240px;
            height: 310px;
            margin-left: 6px;
            margin: 4px ;
            border: 10px solid transparent;
        }

        .movielist a img {
            display: block;
            width: 240px;
            height: 310px;
            border-radius: 10px;
        }
        .movielist a:hover , .movielist a.currentFocus  {
            border: 10px solid #355bc7;
            box-shadow: 0 0 10px #355bc7;
            border-radius: 10px;
        }
        .movie-duration{
            height: 30px;
            line-height: 30px;
            font-size: 22px;
            margin: 10px 0px;
            color: yellow;
        }

        .movie-duration img{
            position: relative;
            top: 3px;
        }
        .movie-duration span{
            margin:0px 20px;
        }

        .movie-info {
            clear: both;
            font-size: 22px;
            height: 120px;
            letter-spacing: 2px;
            width: 480px;
            overflow: hidden;
            color: white;
            margin-top: 10px;
        }

        .movie-button {float: left;margin-top: 46px;margin-left: 40px;}

        .movie-img {
            /* margin: 30px 0px 0px 40px; */
            margin: 0 auto;
        }
        .movieinfo img{margin: 0 auto;}
        .tvinfo{
            height: 400px;
            overflow: hidden;
            width: 1350px;
            margin-left: 50px;
            font-size: 26px;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
<!-- 最外层布局div -->
<div class="tvmain">
    <!-- 悬浮条美丽英语 -->
    <div class="tvtitle" id="tvtitle"></div>
    <!-- 设置背景的div -->
    <div class="tvcontent" style="background-image: url(img/hs2.png)">
        <div id="catelist" class="catelist tvleft" style="display: none;">
            <a id="c{CATEID}"
               onfocus="fixCateFocus(this);itemList.loadList({CATEID} , this, {IDX});"
               onclick="fixCateFocus(this);itemList.showList({CATEID} , this);"
               onblur="fixCateBlur(this)"
               href="javascript:;">{CATENAME}</a>
        </div>
        <div class="timenow" style="width: 100%;height: 100px;">
            <script>
                setInterval("timenow.innerHTML=new Date().toLocaleString()+' 星期'+'日一二三四五六'.charAt(new Date().getDay());",1000);
            </script>
        </div>
        <div class="tvtop" id="tvtop">
            <div id="movieinfo" class="movieinfo" style="display: block;">
                <!--<img class="movie-img" src="{MIMG}" onerror="fixImgError(this);"/>-->
            </div>
        </div>
        <div class="tvinfo" id="movielist">
        </div>
    </div>
    <div id="pagenum" class="pagenum" style="display: none;"></div>
</div>
</body>
</html>
<script type="text/javascript" src="../video/public/js/lang.js"></script>
<script type="text/javascript" src="../video/public/js/config.js"></script>
<script type="text/javascript" src="../video/public/js/jsget.js"></script>
<script type="text/javascript" src="../../js/cate.js"></script>
<script type="text/javascript" src="../public/js/bo.js"></script>
<script type="text/javascript" src="../video/public/js/sharedata.js"></script>
<script type="text/javascript" src="../js/querystring.js"></script>
<script type="text/javascript">
    function $(e) {
        return document.getElementById(e);
    }
    var file_obj = null;
    function setTopLogo( do_update ) {
        var logo_path = localStorage.getItem("logo_path");
        if ( !! logo_path ) {
            var ele = document.getElementById("toplogo");
            //if( !!ele ) ele.src = "file://" + logo_path;
        }

        var bg_path = localStorage.getItem("bg_path");
        if ( !! bg_path ) {
            var ele = document.body;
            if( !!ele ) ele.style.backgroundImage = "url(file://"+bg_path+")";
        }

        if ( do_update == false ) return;

        if ( file_obj == null ) {
            try {
                file_obj = wae.create("DATA.File");
            }catch(e) {
                setTimeout( function() {setTopLogo( true );}, 1000  );
                return;
            }
        }

        // var path = file_obj.readAll( file_obj.getFilesDir() + "/logo.loc"  );
        // if ( !!path )	localStorage.setItem( "logo_path", path );
        // alert( path );
        path = file_obj.readAll( file_obj.getFilesDir() + "/bg.loc"  );
        if ( !!path )  localStorage.setItem( "bg_path", path );

        setTopLogo( false );
    }

    setTopLogo( true );
    function setUniClass( ele, classname ) {
        var eles = document.getElementsByClassName( classname );
        if ( !! eles && !! eles.length ) {
            for( var i=0; i<eles.length; i++ ) {
                var cele = eles[i];
                cele.className = cele.className.replace( classname, " ").replace( /\s+/, " ");
            }
        }
        ele.className = ele.className + " " + classname;
    }

    function fixCateFocus( ele ) {
        setUniClass( ele, "catlistSel");
    }
    function fixCateBlur( ele ) {
    }

    function fixImgError( ele ) {
        ele.src = "image/def.png";
    }

    function fixItemBlur(ele ) {
        // var iele = ele.getElementsByTagName("span")[0];
        // iele.innerHTML =  ele.textstr ;
    }

    function fixItemFocus( ele ) {
        if ( ! ele.textstr )
            ele.textstr = iele.innerHTML.replace(/<[^>]+>/g, "");
    }


    var cateList = new CateList();
    cateList.ele = document.getElementById("catelist");
    cateList.htmltemp = cateList.ele.innerHTML;
    cateList.cateInfo = null;
    cateList.onload = function( category, info ) {
        this.cateInfo = category;
        var mc_str = "";
        for( var i = 0; i< category.length ; i++ ) {
            if ( i >= 9 ) break;
            var str = cateList.htmltemp
                .replace("{CATENAME}", category[i].cat_name)
                .replace(/{CATEID}/g, category[i].cat_id)
                .replace(/{IDX}/g, i);
            mc_str += str;
        }

        cateList.ele.innerHTML = mc_str;
        cateList.ele.style.display = "block";

        var catid = parseInt(sessionStorage.getItem('cate_id') ) ;
        sessionStorage.removeItem('cate_id');

        var cele = null;
        if ( isNaN( catid) )  {
            catid = cateList.curid;
        }

        for( var i = 0; i< category.length ; i++ ) {
            if ( catid == category[i].cat_id ) {
                cele = cateList.ele.getElementsByTagName("a")[i];
                break;
            }
        }

        if ( cele == null ) {
            cele = cateList.ele.getElementsByTagName("a")[0];
        }

        setTimeout( function() {
            VatataKeyMove.initById( cele );
        }, 500 );
        // itemList.loadList( catid, cele );
    }

    window.onWAEReady = function() {
        var uiSettings = wae.create("UI.UISettings");
        uiSettings.set1080P();
        var settingObj = wae.create("WAE.Setting");
        settingObj.setUseLocalImageCache(true);

        var param = wae.create("DATA.Parameters");
        var title = param.get("title");
        if(title)  document.getElementById("tvtitle").innerText = title;
        var cid = param.get("DATA");

        if ( ! cid )
            cid = param.get("apiUrl");

        var res = cid.match(new RegExp("cat_id=(\\d+)","i"));
        if ( res )
            cid = res[1];

        if ( isNaN(parseInt(Request.q("cid",""))) == false ) {
            cid = Request.q("cid","");
        }

        if( !cid ) {
            alert("Fatal: no category!");
            var app = wae.create("Application");
            app.finishActivity();
            return;
        }

        var subcid = "";
        if ( isNaN(parseInt(Request.q("subcid",""))) == false ) {
            subcid = Request.q("subcid","");
            sessionStorage.setItem('cate_id', subcid );
        }

        cateList.load( cid );
        cateList.curid = cid;
    }

    function addItem() {
        var c = parseInt($("itemnum").innerHTML) + 1;
        if ( isNaN(c) ||  c < 0 ) c = 0;
        $("itemnum").innerHTML = c;
    }
    function decItem() {
        var c = parseInt($("itemnum").innerHTML) - 1;
        if ( isNaN(c) || c < 0 ) c = 0;
        $("itemnum").innerHTML = c;
    }
    function saveItem() {
        var c = parseInt($("itemnum").innerHTML);
        if ( isNaN(c) || c<0 ) c = 0;
        var totalPrice = null;
        var cartMessage = "";
        var s = mediaItem.iid+","+mediaItem.minfo.name+"," + c + "," + mediaItem.minfo.price + ",,\n";
        cartMessage += s;
        totalPrice += c * parseFloat(mediaItem.minfo.price);

        cartMessage += "\n,Total,," +  totalPrice + ",,\n";

        var msgItem = new MessageList();
        msgItem.onload = function( msgInfo ) {
            var res = JSON.parse(msgInfo);
            alert(res.msg);
        }
        msgItem.load( 999999, mediaItem.minfo.name, deviceInfo.info.contacts, cartMessage , deviceInfo.info.customer1);
        // history.go(-1);
    }


    var itemList = new ItemList();
    itemList.ele = document.getElementById("movielist");
    itemList.logo = document.getElementById("movieinfo");
    itemList.about = document.getElementById("movielist");
    itemList.htmltemp = itemList.ele.innerHTML;
    itemList.selCateEle = null;
    itemList.loadList = function( cid , ele, idx) {
        var cateInfo = cateList.cateInfo[idx];
        this.logo.innerHTML = "<img class='movie-img' src='"+ cateInfo.icon1 + "' />";
        this.about.innerHTML = cateInfo.cat_desc.replace(/\n/g, "<br>");
    }
    itemList.showList = function( cid, ele) {
        location.href = "list2.html?aci=&cid=" + cid;
    }


    itemList.getHtml = function( offset , listInfo ) {
        var ml_str = "";
        for( var i = 0; i<listInfo.length; i++ ) {
            var idx = offset + i;
            var str = itemList.htmltemp
                .replace( "{IDX}", idx)
                .replace( "{CID}", itemList.cid)
                .replace(/{MID}/g, listInfo[i].id )
                .replace("{MIMG}", listInfo[i].logo )
                .replace("{MNAME}", listInfo[i].name );
            ml_str += str;
        }

        return ml_str;
    }


    itemList.onload = function( listInfo, totalCount, totalPage ) {
        // //VatataKeyMove.initById( itemList.ele.getElementsByTagName("a")[0]);
        itemList.loadItem( listInfo[0].id, 0 );
    }

    itemList.loadItem = function( mid , idx ) {
        mediaItem.iid = mid;
        mediaItem.load( mid );
        var pageNo = Math.floor( idx / 5 ) + 1;
        // document.getElementById("pagenum").innerHTML = "页码： " + pageNo + "/" + itemList.totalPage;
    }

    var mediaItem = new PhotoItem();
    mediaItem.boInfo = new BOInfo();
    mediaItem.boInfo.load();
    mediaItem.logo = document.getElementById("movieinfo");
    mediaItem.about = document.getElementById("movielist");
    mediaItem.iid = null;
    mediaItem.minfo = null;
    mediaItem.onload = function( mediaInfo, sourceList ) {
        alert(JSON.stringify(mediaInfo));
        this.logo.innerHTML = "<img class='movie-img' src='"+ mediaInfo.logo + "' />";
        this.about.innerHTML = mediaInfo.about.replace(/\n/g, "<br>");
        // mediaItem.ele.innerHTML = str;
    }

    mediaItem.mediaPlay = function() {
        var title = this.mediaInfo.title;
        var murl = this.mediaInfo.urlAddress;
        if ( ! this.tvappobj ) this.tvappobj = wae.create("TvApp");
        this.tvappobj.putExtra("URLS", murl);
        this.tvappobj.putExtra("title", title );
        this.tvappobj.putExtra("vindex", -1 );
        this.tvappobj.start( "player/player.html");
    }
    mediaItem.clickItem = function( mid , cid ) {
        if ( ! this.mediaInfo || mid != mediaItem.mid ) {
            setTimeout( function() {
                mediaItem.clickItem( mid, cid );
            }, 1000 );
            mediaItem.iid = mid;
            mediaItem.load( mid );
            return;
        }

        var catename = "";
        if ( !!itemList.selCateEle ) catename = itemList.selCateEle.innerHTML;

        var iurl = "info.html?cid="+cid+"&mid="+mid + "&catename=" + encodeURIComponent(catename);
        if ( ! mediaItem.tvappobj )  mediaItem.tvappobj = wae.create("TvApp");
        mediaItem.tvappobj.open( iurl );

        return;

    }


    // itemList.ele
    const KEY_W = 87
    const KEY_S = 83;

    itemList.ele['up'] = function() {
        return document.getElementById("movie-button").getElementsByTagName("a")[0];
    }


    itemList.ele['down'] = function() {
        return itemList.ele.getElementsByTagName("a")[0];
    }


    itemList.ele['left'] = function() {
        // setUniClass( ele, "catlistSel");
        return document.getElementsByClassName("catlistSel")[0];
    }

    cateList.ele['right'] = function() {
        return itemList.ele.getElementsByTagName("a")[0];
    }

</script>
<script type="text/javascript" src="../video/public/js/deviceinfo.js"></script>
<script type="text/javascript">
    var deviceInfo = new DeviceInfo();
    deviceInfo.onload = function( dinfo ) {
    }
    deviceInfo.load();

</script>
<script type="text/javascript" src="player/js/key.js"></script>
