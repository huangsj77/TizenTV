<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Movie List</title>
    <meta name="viewport" content="width=1920" />
    <link rel="stylesheet" href="../message/public.css"/>
    <link rel="stylesheet" href="../video/css/movie.css"/>
    <style type="text/css">
        .tvtitle {

        }

        .tvlist {
            width: 1380px;
            height: 350px;
            overflow: hidden;
        }

        .movielist {
            position: relative;
            overflow: hidden;
            height: 350px;
            margin-left: 20px;
        }
        .movielist a {
            float: left;
            display: block;
            text-align: center;
            width: 240px;
            height: 310px;
            margin-left: 6px;
            margin: 4px ;
            border: 10px solid transparent;
        }

        .movielist a img {	
	    display: block;
	    width: auto;
            height: 310px;
            position: absolute;
            clip: rect(0px,240px,310px,0px);
        }
        .movielist a:hover , .movielist a.currentFocus  {
            border: 10px solid #355bc7;
            box-shadow: 0 0 10px #355bc7;
            border-radius: 10px;
        }
        .movie-duration{
            height: 30px;
            line-height: 30px;
            font-size: 22px;
            margin: 10px 0px;
            color: yellow;
        }

        .movie-duration img{
            position: relative;
            top: 3px;
        }
        .movie-duration span{
            /*margin:0px 20px;*/
        }

        .movie-info {
            clear: both;
            font-size: 22px;
            max-height: 130px;
            height: 130px;
            letter-spacing: 2px;
            width: 480px;
            overflow: hidden;
            color: white;
            margin-top: 10px;
        }

        .movie-button {float: left;margin-top: 38px;margin-left: 40px;}
        .chose-button{
            width: 100px;
            height: 120px;
            display: block;
            float: left;
        }
        .chose-button a{display: block;}
        .btn-up{
            margin-left: 35px;
            margin-bottom: 15px;
            /*float: left;*/
            display: block;
            width: 0;
            height: 0;
            border-width: 15px;
            border-style: solid;
            border-color:transparent transparent #0b6cbc  transparent;
            border-bottom-width: 20px;
        }

        .btn-down{
            width: 15px;
            margin-left: 35px;
            margin-top: 15px;
            display: block;
            width: 0;
            height: 0;
            border-width: 15px;
            border-style: solid;
            border-color:#0b6cbc transparent transparent transparent;
            border-top-width: 20px;
        }

        .chose-button a.btn-up:hover, .chose-button a.btn-up.currentFocus {
            border-color:transparent transparent #ffffff transparent;
        }
        .chose-button a.btn-down:hover, .chose-button a.btn-down.currentFocus {
            border-color:#ffffff transparent transparent transparent;
        }
        .chose-button span{width: 100px;height: 40px;line-height: 40px;display: block;font-size: 28px;color: grey;text-align: center;}
    </style>
</head>
<body>
<!-- 最外层布局div -->
<div class="tvmain">
    <!-- 悬浮条美丽英语 -->
    <div class="tvtitle" id="tvtitle"></div>
    <!-- 设置背景的div -->
    <div class="tvcontent" style="background-image: url(img/hs2.png)">
        <div id="catelist" class="catelist tvleft" style="display: none;">
            <a id="c{CATEID}"
               onfocus="fixCateFocus(this);itemList.loadList({CATEID} , this);"
               onclick="fixCateFocus(this);itemList.loadList({CATEID} , this);"
               onblur="fixCateBlur(this)"
               href="javascript:;">{CATENAME}</a>
        </div>
        <div class="timenow" style="width: 100%;height: 100px;">
            <script>
                setInterval("timenow.innerHTML=new Date().toLocaleString()+' 星期'+'日一二三四五六'.charAt(new Date().getDay());",1000);
            </script>
        </div>
        <div class="tvtop" id="tvtop">

            <div id="movieinfo" class="movieinfo" style="display: none;">
                <div style="float: left;width: 760px; height:530px;display: inline-block;background: url(./image/img_bg.png) no-repeat;">
                    <img class="movie-img" src="{MIMG}" onerror="fixImgError(this);"/>
                </div>
                <div style="float:left;height:420px;display:inline-block; width:520px;padding-left:30px;margin-top:50px;font-size: 42px;">
                    <div class="movie-title">
                        {MNAME}
                    </div>
                    <div class="movie-duration">
                        <span id="runtime">{MDURATION}</span>
                    </div>
                    <div class="movie-info" id="movie-info">
                        {MINTRO}
                    </div>
                    <div id="chose-button" class="chose-button">
                        <a class="btn-up" href="javascript:addItem()"></a>
                        <span id="itemnum" style="background: url(./image/input_bg.png) no-repeat;">1</span>
                        <a class="btn-down" href="javascript:decItem();"></a>
                    </div>
                    <div id="movie-button" class="movie-button">
                        <a href="javascript:saveItem()">OK</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="tvlist">
            <div id="movielist" class="movielist" style="display:block; float: left;">
                <!--<a href="javascript:;"-->
                   <!--onfocus="itemList.loadItem({MID},{IDX});">-->
                    <!--<img src="{MIMG}" />-->
                <!--</a>-->
            </div>
        </div>
    </div>
    <div id="pagenum" class="pagenum" style="display: block;"></div>
</div>
</body>
</html>
<script type="text/javascript" src="../video/public/js/lang.js"></script>
<script type="text/javascript" src="../video/public/js/config.js"></script>
<script type="text/javascript" src="../video/public/js/jsget.js"></script>
<script type="text/javascript" src="../../js/cate.js"></script>
<script type="text/javascript" src="../public/js/bo.js"></script>
<script type="text/javascript" src="../video/public/js/sharedata.js"></script>
<script type="text/javascript" src="../js/querystring.js"></script>
<script type="text/javascript">
    function $(e) {
        return document.getElementById(e);
    }

    var file_obj = null;
    function setTopLogo( do_update ) {
        var logo_path = localStorage.getItem("logo_path");
        if ( !! logo_path ) {
            var ele = document.getElementById("toplogo");
            //if( !!ele ) ele.src = "file://" + logo_path;
        }

        var bg_path = localStorage.getItem("bg_path");
        if ( !! bg_path ) {
            var ele = document.body;
            if( !!ele ) ele.style.backgroundImage = "url(file://"+bg_path+")";
        }

        if ( do_update == false ) return;

        if ( file_obj == null ) {
            try {
                file_obj = wae.create("DATA.File");
            }catch(e) {
                setTimeout( function() {setTopLogo( true );}, 1000  );
                return;
            }
        }

        // var path = file_obj.readAll( file_obj.getFilesDir() + "/logo.loc"  );
        // if ( !!path )	localStorage.setItem( "logo_path", path );
        // alert( path );
        path = file_obj.readAll( file_obj.getFilesDir() + "/bg.loc"  );
        if ( !!path )  localStorage.setItem( "bg_path", path );

        setTopLogo( false );
    }

    setTopLogo( true );

    function setUniClass( ele, classname ) {
        var eles = document.getElementsByClassName( classname );
        if ( !! eles && !! eles.length ) {
            for( var i=0; i<eles.length; i++ ) {
                var cele = eles[i];
                cele.className = cele.className.replace( classname, " ").replace( /\s+/, " ");
            }
        }
        ele.className = ele.className + " " + classname;
    }

    function fixCateFocus( ele ) {
        setUniClass( ele, "catlistSel");
    }
    function fixCateBlur( ele ) {
    }

    function fixImgError( ele ) {
    }

    function fixItemBlur(ele ) {
        // var iele = ele.getElementsByTagName("span")[0];
        // iele.innerHTML =  ele.textstr ;
    }

    function fixItemFocus( ele ) {
        if ( ! ele.textstr )
            ele.textstr = iele.innerHTML.replace(/<[^>]+>/g, "");
    }


    var cateList = new CateList();
    cateList.ele = document.getElementById("catelist");
    cateList.htmltemp = cateList.ele.innerHTML;
    cateList.onload = function( category, info ) {
        var mc_str = "";
        for( var i = 0; i< category.length ; i++ ) {
            if ( i >= 9 ) break;
            var str = cateList.htmltemp
                .replace("{CATENAME}", category[i].cat_name)
                .replace(/{CATEID}/g, category[i].cat_id);
            mc_str += str;
        }

        cateList.ele.innerHTML = mc_str;
        cateList.ele.style.display = "block";

        var catid = parseInt(sessionStorage.getItem('cate_id') ) ;
        sessionStorage.removeItem('cate_id');

        var cele = null;
        if ( isNaN( catid) )  {
            catid = cateList.curid;
        }

        for( var i = 0; i< category.length ; i++ ) {
            if ( catid == category[i].cat_id ) {
                cele = cateList.ele.getElementsByTagName("a")[i];
                break;
            }
        }

        if ( cele == null ) {
            cele = cateList.ele.getElementsByTagName("a")[0];
        }

        setTimeout( function() {
            VatataKeyMove.initById( cele );
        }, 500 );
        // itemList.loadList( catid, cele );
    }

    window.onWAEReady = function() {
        var uiSettings = wae.create("UI.UISettings");
        uiSettings.set1080P();
        var settingObj = wae.create("WAE.Setting");
        settingObj.setUseLocalImageCache(true);

        var param = wae.create("DATA.Parameters");
        var title = param.get("title");
        if(title)  document.getElementById("tvtitle").innerText = title;
        var cid = param.get("DATA");

        if ( ! cid )
            cid = param.get("apiUrl");

        var res = cid.match(new RegExp("cat_id=(\\d+)","i"));
        if ( res )
            cid = res[1];

        if ( isNaN(parseInt(Request.q("cid",""))) == false ) {
            cid = Request.q("cid","");
        }

        if( !cid ) {
            alert("Fatal: no category!");
            var app = wae.create("Application");
            app.finishActivity();
            return;
        }

        var subcid = "";
        if ( isNaN(parseInt(Request.q("subcid",""))) == false ) {
            subcid = Request.q("subcid","");
            sessionStorage.setItem('cate_id', subcid );
        }

        cateList.load( cid );
        cateList.curid = cid;
    }

    function addItem() {
        var c = parseInt($("itemnum").innerHTML) + 1;
        if ( isNaN(c) ||  c < 0 ) c = 0;
        $("itemnum").innerHTML = c;

        var total = document.getElementById("runtime");
        var total_price = (c * parseFloat(mediaItem.minfo.price)).toFixed(2);
        total.innerText = "Rs." +total_price;
    }
    function decItem() {
        var c = parseInt($("itemnum").innerHTML) - 1;
        if ( isNaN(c) || c < 1 ) c = 1;
        $("itemnum").innerHTML = c;

        var total = document.getElementById("runtime");
        var total_price = (c * parseFloat(mediaItem.minfo.price)).toFixed(2);
        total.innerText = "Rs. "+ total_price;
    }
    function saveItem() {
        var c = parseInt($("itemnum").innerHTML);
        if ( isNaN(c) || c<0 ) c = 0;
        var totalPrice = null;
        var cartMessage = "";
        var s = mediaItem.iid+","+mediaItem.minfo.name+"," + c + "," + mediaItem.minfo.price + ",,\n";
        cartMessage += s;
        totalPrice += c * parseFloat(mediaItem.minfo.price);

        cartMessage += "\n,Total,," +  totalPrice + ",,\n";

        var msgItem = new MessageList();
        msgItem.onload = function( msgInfo ) {
            // alert(JSON.stringify(msgInfo));
            var res = JSON.parse(msgInfo);
            alert(res.msg);
            var app = wae.create("Application");
            app.finishActivity();
            return
        }

        msgItem.load( 999999, mediaItem.minfo.name, deviceInfo.info.contacts, cartMessage , deviceInfo.info.customer1);
        // history.go(-1);
    }


    var itemList = new ItemList();
    itemList.ele = document.getElementById("movielist");
    itemList.listEle = document.getElementById("movielist");
    itemList.htmltemp = itemList.ele.innerHTML;
    itemList.selCateEle = null;
    itemList.pageSize0 = 5;
    itemList.pageIndex = 0;
    itemList.listData = null;
    itemList.loadList = function( cid , ele) {
        console.log("loadList " + cid );
        if ( itemList.cid == cid )
            return;
        itemList.selCateEle = ele;
        itemList.load( cid, 1, 50 );
    }

    itemList.getHtml = function( offset , listInfo ) {
        var ml_str = "";
        for( var i = 0; i<listInfo.length; i++ ) {
            var idx = offset + i;
            var str = itemList.htmltemp
                .replace( "{IDX}", idx)
                .replace( "{CID}", itemList.cid)
                .replace(/{MID}/g, listInfo[i].id )
                .replace("{MIMG}", listInfo[i].logo )
                .replace("{MNAME}", listInfo[i].name );
            ml_str += str;
        }

        return ml_str;
    }


    itemList.onload = function( listInfo, totalCount, totalPage ) {
        this.listData = listInfo;
        this.showListHtml();

        return;
        this.startNo = (this.pageNo - 1)*5;
        var ml_str = this.getHtml( this.startNo , listInfo );
        itemList.ele.innerHTML = ml_str;
        itemList.ele.style.display = "block";

        document.getElementById("pagenum").innerHTML = "页码：" + itemList.pageNo + "/" + itemList.totalPage;

        itemList.appender = new ItemList();
        itemList.startNo = (itemList.pageNo - 1 ) * 5;
        itemList.isChanging = false;
        itemList.nextLine = function() {
            if( itemList.startNo + 5 >= itemList.totalCount ) {
                return;
            }
            itemList.isChanging = true;
            itemList.appender.onload = function( linfo, tcount, tpage ) {

                var count = 0;
                for( var j=0; j<itemList.ele.childNodes.length ; j++ ) {
                    var o = itemList.ele.childNodes[0];
                    if ( typeof(o.tagName) == "string" && o.tagName == "A" ) {
                        count ++;
                    }
                    itemList.ele.removeChild( o );
                    if (count >= 4 ) break;
                }

                itemList.startNo = (itemList.appender.pageNo - 1 ) * 4 - 8;
                var ml_str = itemList.getHtml( itemList.startNo + 8, linfo );
                var sele = document.createElement("span");
                sele.innerHTML = ml_str;
                var eles = sele.getElementsByTagName("a");
                while( eles.length > 0) {
                    var o = eles[0];
                    sele.removeChild( o );
                    itemList.ele.appendChild(o);
                }
                itemList.isChanging = false;
            }
            var pageNo = Math.floor((itemList.startNo + 12) / 4) + 1;
            itemList.appender.load( itemList.cid, pageNo, 4 );
        }

        itemList.prevLine = function() {
            if( itemList.startNo <= 0 ) {
                return;
            }

            itemList.isChanging = true;
            itemList.appender.onload = function( linfo, tcount, tpage ) {
                itemList.startNo = (itemList.appender.pageNo - 1 ) * 4 ;
                var ml_str = itemList.getHtml( itemList.startNo + 8, linfo );
                var sele = document.createElement("span");
                sele.innerHTML = ml_str;
                var eles = sele.getElementsByTagName("a");
                for( var j = eles.length -1 ; j>=0 ; j-- ) {
                    var o = eles[j];
                    sele.removeChild( o );
                    itemList.ele.insertBefore(o,itemList.ele.firstChild);
                }
                eles = itemList.ele.getElementsByTagName("a");
                while( eles.length > 5 ) {
                    itemList.ele.removeChild( eles[eles.length-1] );
                    eles = itemList.ele.getElementsByTagName("a");
                }
                itemList.isChanging = false;
            }
            var pageNo = Math.floor((itemList.startNo - 4) / 4) + 1;
            itemList.appender.load( itemList.cid, pageNo, 4 );
        }

        //VatataKeyMove.initById( itemList.ele.getElementsByTagName("a")[0]);
        itemList.loadItem( listInfo[0].id, 0 );
    }

    itemList.showListHtml = function(){
        var pstart = this.pageIndex * this.pageSize0;
        var pend = (this.pageIndex + 1) * this.pageSize0;
        if ( pend > this.listData.length ) pend = this.listData.length;
        var _listHtml = "";
        if( !!this.listData && !!this.listData.length && this.listData.length > 0 ) {
            for(var i=pstart; i<pend; i++ ) {
                _listHtml += "<a id='item_"+ i +"' href='javascript:void()'" +
                    " onfocus='itemList.loadItem("+ this.listData[i].id +","+ itemList.cid +");'>" +
                    "<img src='"+ this.listData[i].logo + "' alt='' height='310px' width='auto'></a>";
            }
            this.listEle.style.dislay = "block";
            this.listEle.innerHTML = _listHtml;

            document.getElementById("pagenum").innerHTML = "Page ：" + (this.pageIndex+1) + "/" +Math.ceil(this.listData.length / this.pageSize0 );

            itemList.loadItem( this.listData[0].id, 0 );
            // var _this = this;
        }
    }

    itemList.listEle['left'] = function() {
        if( itemList.pageIndex > 0 ) {
            itemList.pageIndex -= 1;
            itemList.showListHtml();
            setTimeout(function () {
                VatataKeyMove.initById(itemList.listEle.getElementsByTagName("a")[4]);
            },100)

        } else {
            setTimeout(function () {
                VatataKeyMove.initById(document.getElementsByClassName("activeFocus")[0]);
            },100)
        }
        return null;
    }
    itemList.listEle['right'] = function() {
        var totalPage = Math.ceil(itemList.listData.length / itemList.pageSize0 );
        if( itemList.pageIndex < totalPage - 1) {
            itemList.pageIndex += 1;
            itemList.showListHtml();
            setTimeout(function () {
                VatataKeyMove.initById(itemList.listEle.getElementsByTagName("a")[0]);
            },100);
        }
        return null;
    }

    itemList.loadItem = function( mid , idx ) {
        mediaItem.iid = mid;
        mediaItem.load( mid );
        var pageNo = Math.floor( idx / 5 ) + 1;
        //document.getElementById("pagenum").innerHTML = "页码： " + pageNo + "/" + itemList.totalPage;
    }

    var mediaItem = new PhotoItem();
    mediaItem.boInfo = new BOInfo();
    mediaItem.boInfo.load();
    mediaItem.ele = document.getElementById("movieinfo");
    mediaItem.htmltemp = mediaItem.ele.innerHTML;
    mediaItem.iid = null;
    mediaItem.minfo = null;
    mediaItem.onload = function( mediaInfo, sourceList ) {
        // alert(JSON.stringify(mediaInfo));
        this.minfo = mediaInfo;
        var level = parseInt(mediaInfo.class);
        if ( isNaN(level) || level < 1 || level > 5 )
            level = 1;
        TR("init");
        TR.langObj.setLangName('简体中文');
        var str = mediaItem.htmltemp
            .replace("{MLEVEL}", level)
            .replace("{MTITLE}", "")
            .replace("{DD}", TR("Director"))
            .replace("{DL}", TR("Label"))
            .replace("{DA}", TR("Actor"))
            .replace("{DI}", TR("Intro"))
        ;

        var intro = "";
        var langID = TR.langObj.getLangID();
        if( langID == "cn" && !!mediaInfo.title1 ) {
            str = str
                .replace("{MNAME}", mediaInfo.title)
                .replace("{MLABLE}", mediaInfo.style1)
                .replace("{MDIRECTOR}", mediaInfo.director1)
                .replace("{MACTOR}", mediaInfo.actor1)
                .replace("{MINTRO}", mediaInfo.description1)
            ;
            intro = mediaInfo.description1;
        } else if ( langID == "en" && !!mediaInfo.title2 ) {
            str = str
                .replace("{MNAME}", mediaInfo.title2)
                .replace("{MLABLE}", mediaInfo.style2)
                .replace("{MDIRECTOR}", mediaInfo.director2)
                .replace("{MACTOR}", mediaInfo.actor2)
                .replace("{MINTRO}", mediaInfo.description2)
            ;
            intro = mediaInfo.description2;
        } else if ( langID == "jp" && !!mediaInfo.title3 ) {
            str = str
                .replace("{MNAME}", mediaInfo.title3 )
                .replace("{MLABLE}", mediaInfo.style3 )
                .replace("{MDIRECTOR}", mediaInfo.director3 )
                .replace("{MACTOR}", mediaInfo.actor3 )
                .replace("{MINTRO}", mediaInfo.description3 )
            ;
            intro = mediaInfo.description3;
        } else if ( langID == "kr" && !!mediaInfo.title4 ) {
            str = str
                .replace("{MNAME}", mediaInfo.title4 )
                .replace("{MLABLE}", mediaInfo.style4 )
                .replace("{MDIRECTOR}", mediaInfo.director4 )
                .replace("{MACTOR}", mediaInfo.actor4 )
                .replace("{MINTRO}", mediaInfo.description4 )
            ;
            intro = mediaInfo.description4;
        } else {
            str = str
                .replace("{MNAME}", mediaInfo.name)
                .replace("{MIMG}", mediaInfo.logo)
                .replace("{MLABLE}", "")
                .replace("{MDIRECTOR}", "")
                .replace("{MACTOR}", "")
                .replace("{MDURATION}",(mediaInfo.price)? "Rs."+mediaInfo.price : "")
                .replace("{MINTRO}", mediaInfo.about)
            ;
            intro = mediaInfo.description;
        }
        if ( !intro || intro == ""  ) {
            str = str.replace( "{DISHOW}", "none");
        } else {
            str = str.replace( "{DISHOW}", "");
        }
        mediaItem.ele.innerHTML = str;
        mediaItem.ele.style.display = "block";
    }

    mediaItem.mediaPlay = function() {
        var title = this.mediaInfo.title;
        var murl = this.mediaInfo.urlAddress;
        if ( ! this.tvappobj ) this.tvappobj = wae.create("TvApp");
        this.tvappobj.putExtra("URLS", murl);
        this.tvappobj.putExtra("title", title );
        this.tvappobj.putExtra("vindex", -1 );
        this.tvappobj.start( "player/player.html");
    }
    mediaItem.clickItem = function( mid , cid ) {
        if ( ! this.mediaInfo || mid != mediaItem.mid ) {
            setTimeout( function() {
                mediaItem.clickItem( mid, cid );
            }, 1000 );
            mediaItem.iid = mid;
            mediaItem.load( mid );
            return;
        }

        var catename = "";
        if ( !!itemList.selCateEle ) catename = itemList.selCateEle.innerHTML;

        var iurl = "info.html?cid="+cid+"&mid="+mid + "&catename=" + encodeURIComponent(catename);
        if ( ! mediaItem.tvappobj )  mediaItem.tvappobj = wae.create("TvApp");
        mediaItem.tvappobj.open( iurl );

        return;

    }


    // itemList.ele
    const KEY_W = 87
    const KEY_S = 83;

    itemList.ele['up'] = function() {
        return document.getElementById("movie-button").getElementsByTagName("a")[0];
    }


    itemList.ele['down'] = function() {
        return itemList.ele.getElementsByTagName("a")[0];
    }


    itemList.ele['left'] = function() {
        // setUniClass( ele, "catlistSel");
        return document.getElementsByClassName("catlistSel")[0];
    }

    cateList.ele['right'] = function() {
        return itemList.ele.getElementsByTagName("a")[0];
    }

</script>
<script type="text/javascript" src="../video/public/js/deviceinfo.js"></script>
<script type="text/javascript">
    var deviceInfo = new DeviceInfo();
    deviceInfo.onload = function( dinfo ) {
    }
    deviceInfo.load();

</script>
<script type="text/javascript" src="player/js/key.js"></script>
