<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MAIN CATE</title>
    <meta name="viewport" content="width=1920" />
    <link rel="stylesheet" href="../message/public.css"/>
    <link rel="stylesheet" href="../video/css/movie.css"/>
</head>
<body>
  <div id="maincateView" class="tvmain">
    <div class="tvcontent" style="background-image: url(image/bg_maincate.jpg)">
      <div id="maincate" class="maincate" style="display: none;">
        <a
          onfocus="this.style.backgroundImage='url(image/bg_l_btnh.png)'"
          onblur="this.style.backgroundImage=''"
         href="javascript:;" onclick="cateList.clickItem({CATEID},{IDX})">{CATENAME}</a>
      </div>
    </div>
    <div class="remoterhintv"></div>
  </div>

</body>
</html>
<script type="text/javascript" src="../video/public/js/config.js"></script>
<script type="text/javascript" src="../video/public/js/jsget.js"></script>
<script type="text/javascript" src="../../js/cate.js"></script>
<script type="text/javascript" src="../video/public/js/deviceinfo.js"></script>
<script type="text/javascript" src="player/js/key.js"></script>
<script type="text/javascript" src="../js/querystring.js"></script>
<script type="text/javascript">

var cateList = new CateList();
cateList.loadTimer = setTimeout( function(){
  console.log("MainCate load failed, reload page!");
  location.reload();
}, 1000 * 20);

cateList.roomName = "default";

cateList.ele = document.getElementById("maincate");
cateList.htmltemp = maincate.innerHTML;
cateList.onload = function( category ) {
  if ( cateList.roomName == "" ) {
    cateList.roomName = "default";
  }

  var foundIdx = -1;
  for( var i = 0; i< category.length ; i++ ) {
    if( category[i].cat_name == cateList.roomName ) {
      foundIdx = i;
      break;
    }
  }

  if ( foundIdx == -1 ) {
    for( var i = 0; i< category.length ; i++ ) {
      var rooms = category[i].cat_desc.split( /[,;\n\r\t ]+/ );
      for( var j=0; j<rooms.length; j++ ) {
        if ( rooms[j] == cateList.roomName ) {
          foundIdx = i;
          break;          
        }
      }
      if( foundIdx != -1 ) {
        break;
      }
    }
  }

  if ( foundIdx == -1 ) {
    cateList.roomName = "default";
    for( var i = 0; i< category.length ; i++ ) {
      if( category[i].cat_name == cateList.roomName ) {
        foundIdx = i;
        break;
      }
    }
  }

  var subcate = category;
  this.subcate = subcate;

  if ( foundIdx != -1 ) {
    subcate = category[foundIdx].children;
    this.subcate = subcate;
  }

  var mc_str = "";
  for( var j = 0; j< subcate.length ; j++ ) {
        if ( j >= 4 ) break;
        var res = subcate[j].dataUrl.match(new RegExp("cat_id=(\\d+)","i"));
        var cid = subcate[j].cat_id;
        if ( res )
          cid = res[1];
        subcate[j].fix_cid = cid;

        var str = cateList.htmltemp
                      .replace("{CATENAME}", subcate[j].cat_name)
                      .replace("{IDX}", j )
                      .replace("{CATEID}", subcate[j].fix_cid);
        mc_str += str;
  }
  if( mc_str != ""  && cateList.loadTimer != null ) {
    clearTimeout( cateList.loadTimer );
    cateList.loadTimer = null;
  }
  maincate.innerHTML = mc_str;
  maincate.style.display = "block";
  VatataKeyMove.initDefault();
}

cateList.clickItem = function( subcid , idx ) {
  if ( !! this.subcate[idx] ) {
    var passwd = this.subcate[idx].password;
    if ( !! passwd ) {
      var url = "inputpass.html?cid=" + subcid ;
      var wobj = wae.create("WAE.Window");
      wobj.onClose = function(a) {
        var res = a.arguments[0];
        if ( res == passwd ) {
          location.href="list.html?cid=" + subcid;
        } else {
          alert("Invalid PasswordÔºÅ");
        }
      }
      wobj.open( url );
      return;
    }
  }
  location.href="list.html?cid=" + subcid;
}


//alert(Request.q("cid",""))

//  setTimeout( function() {
//    if ( document.getElementById("maincate").style.display == "none" )
//      cateList.load( 1750 ); // for debug
//  } , 1000 );

  window.onWAEReady = function() {
    var settingObj = wae.create("WAE.Setting");
    settingObj.setUseLocalImageCache(true);
    
    var uiSettings = wae.create("UI.UISettings");
    uiSettings.set1080P();

    if ( isNaN(parseInt(Request.q("cid",""))) == false ) {

        var devInfo = new DeviceInfo();
        devInfo.onload = function(info) {
          cateList.roomName  = info.contacts;
          cateList.skipcache = true;
          cateList.load( Request.q("cid","") );
        }
        devInfo.load();
        return;
    }

    var param = wae.create("DATA.Parameters");
    var title = param.get("name");
    var apiUrl = param.get("apiUrl");
    
    var dataUrl = param.get("dataUrl");
    localStorage.setItem("AD_CATE", dataUrl );

    var res = apiUrl.match(new RegExp("cat_id=(\\d+)","i"));
    var cid = apiUrl;
    if ( res )
      cid = res[1];
    var cat_id = sessionStorage.getItem("CAT_ID");          
    if ( cat_id )                                
        cid = cat_id;

    var devInfo = new DeviceInfo();
    devInfo.onload = function(info) {
      cateList.roomName  = info.contacts;
      cateList.skipcache = true;
      cateList.load( cid );
    }
    devInfo.load();
  }


</script>


