<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Movie Info</title>
    <link rel="stylesheet" href="../message/public.css"/>
    <link rel="stylesheet" href="../video/css/movie.css"/>
</head>
<body>
<div class="tvmain">
  <div class="tvcontent" style="background-image: url(image/bg_info.jpg)">
		<div id="movieinfo" class="show-main" style="display:none">
	        <img class="show-level" src="image/l_{MLEVEL}.png"/>
	        <img class="show-img" src="{MIMG}"/>
			<div class="show-info">
	            <div class="show-title1">{MNAME}</div>
	            <div class="show-title2">{MTITLE}</div>
	            <div class="show-items">
	               <div class="show-item">{DD} : {MDIRECTOR} </div>
	               <div class="show-item">{DL} : {MLABLE} </div>
                 <div class="show-item">{DA} : {MACTOR} </div>
                 <div class="show-item" style="display: block; float: right; margin-right: 50px;"> {SUBTITLE} </div>
				</div>
        <a id="freePlayBtn" href="javascript:;" onclick="mediaItem.playWithAD();">播放</a>
				<a id="previewBtn"  href="javascript:;" onclick="mediaItem.preview();">试看</a>
				<a id="payBtn"      href="javascript:;" onclick="mediaItem.pay();"><span id="payLabel">付费</span><br/>NTD {MSCORE}</a>
				<a id="payPlayBtn"  href="javascript:;" onclick="mediaItem.play();">播放</a>
			</div>
	        <div class="show-info2">{DI} : <span>{MINTRO}</span></div>
		</div>
  </div>
  <div class="tvtitle" id="tvtitle"></div>
  <div class="remoterhint"></div>
</div>

	<div class="show" style="display: none;">
	</div>

</body>
</html>
<script type="text/javascript" src="../video/public/js/lang.js"></script>
<script type="text/javascript">
document.getElementById("freePlayBtn").innerHTML = TR("Play");
document.getElementById("previewBtn").innerHTML = TR("Preview");
document.getElementById("payLabel").innerHTML = TR("Pay");
document.getElementById("payPlayBtn").innerHTML = TR("Play");
</script>
<script type="text/javascript" src="../video/public/js/config.js"></script>
<script type="text/javascript" src="../video/public/js/jsget.js"></script>
<script type="text/javascript" src="../../js/cate.js"></script>
<script type="text/javascript" src="player/js/key.js"></script>
<script type="text/javascript" src="../js/querystring.js"></script>
<script type="text/javascript" src="../video/public/js/deviceinfo.js"></script>
<script type="text/javascript" src="../movie/js/adinfo.js"></script>
<script type="text/javascript" src="../video/js/adplayer.js"></script>

<script type="text/javascript">
var deviceInfo = new DeviceInfo();
deviceInfo.onload = function( dinfo ) {}
deviceInfo.load();
</script>

<script type="text/javascript">


var mediaItem = new MediaItem();
mediaItem.ele = document.getElementById("movieinfo");
mediaItem.htmltemp = mediaItem.ele.innerHTML;
mediaItem.onload = function( mediaInfo, sourceList ) {
  var level = parseInt(mediaInfo.class);
  if ( isNaN(level) || level < 1 || level > 5 )
    level = 1;

  var subtitleinfo = "";
  var slist = mediaInfo.subtitle.split(',');
  for( var i =0; i<slist.length; i++ ) {
    var v = parseInt( slist[i]);
    if ( isNaN(v) ) continue;
    switch( v ) {
      case 1: subtitleinfo += " 繁"; break;
      case 2: subtitleinfo += " 简"; break;
      case 3: subtitleinfo += " EN"; break;
      case 4: subtitleinfo += " 日"; break;
      case 5: subtitleinfo += " 한"; break;
    }
  }

  var price = Math.floor(parseFloat(mediaInfo.score));
  var str = mediaItem.htmltemp
              .replace("{MIMG}", mediaInfo.imgAddress)
              .replace("{MLEVEL}", level)
              .replace("{MTITLE}", "")
              .replace("{MSCORE}", price)
              .replace("{DD}", TR("Director"))
              .replace("{DL}", TR("Label"))
              .replace("{DA}", TR("Actor"))
              .replace("{DI}", TR("Intro"))
              .replace("{SUBTITLE}", subtitleinfo )
              ;

  TR("init");
  var langID = TR.langObj.getLangID();
  if( langID == "cn") {
    str = str
          .replace("{MNAME}", mediaInfo.title1)
          .replace("{MLABLE}", mediaInfo.style1)
          .replace("{MDIRECTOR}", mediaInfo.director1)
          .replace("{MACTOR}", mediaInfo.actor1)
          .replace("{MINTRO}", mediaInfo.description1)
          ;
  } else if ( langID == "en") {
    str = str
          .replace("{MNAME}", mediaInfo.title2)
          .replace("{MLABLE}", mediaInfo.style2)
          .replace("{MDIRECTOR}", mediaInfo.director2)
          .replace("{MACTOR}", mediaInfo.actor2)
          .replace("{MINTRO}", mediaInfo.description2)
          ;
  } else if ( langID == "jp" ) {
    str = str
          .replace("{MNAME}", mediaInfo.title3 )
          .replace("{MLABLE}", mediaInfo.style3 )
          .replace("{MDIRECTOR}", mediaInfo.director3 )
          .replace("{MACTOR}", mediaInfo.actor3 )
          .replace("{MINTRO}", mediaInfo.description3 )
          ;
  } else if ( langID == "kr" ) {
    str = str
          .replace("{MNAME}", mediaInfo.title4 )
          .replace("{MLABLE}", mediaInfo.style4 )
          .replace("{MDIRECTOR}", mediaInfo.director4 )
          .replace("{MACTOR}", mediaInfo.actor4 )
          .replace("{MINTRO}", mediaInfo.description4 )
          ;
  } else {
    str = str
          .replace("{MNAME}", mediaInfo.title)
          .replace("{MLABLE}", mediaInfo.style)
          .replace("{MDIRECTOR}", mediaInfo.director)
          .replace("{MACTOR}", mediaInfo.actor)
          .replace("{MINTRO}", mediaInfo.description)
          ;
  }

  mediaItem.ele.innerHTML = str;
  if ( price == 0 ) {
  	document.getElementById("previewBtn").style.display = "none";
    document.getElementById("payBtn").style.display = "none";
    document.getElementById("payPlayBtn").style.display = "none";
    document.getElementById("tvtitle").innerHTML = "免費電影";
    adInfo.onGetDevInfo();
  }
  else {
    document.getElementById("payPlayBtn").style.display = "none";
    document.getElementById("freePlayBtn").style.display = "none";
    document.getElementById("tvtitle").innerHTML = "付費電影";

    var k = "pay_" + mediaInfo.autoid;
    var ptime = localStorage.getItem( k );
    var now = (new Date()).getTime();

    var t = (now - ptime )/1000;
    if ( t > 3600 * 24 ) {
      localStorage.removeItem( k );
    } else {
      document.getElementById("previewBtn").style.display = "none";
      document.getElementById("payBtn").style.display = "none";
      document.getElementById("payPlayBtn").style.display = "";      
    }
  }
  mediaItem.ele.style.display = "block";

}
mediaItem.preview = function() {
	var title = this.mediaInfo.title;
	var murl = this.mediaInfo.urlAddress;

/*
    if ( murl.indexOf("file://") >= 0 ) {
        murl = murl.substring( 7 );
    }
*/
  murl = "preview://" + murl;
  
  var wae_player_obj = wae.create("Media.TvataPlayer");
  wae_player_obj.start( murl, "[ {'title' : '" + title + "'}]");	
}

mediaItem.play = function() {
	var title = this.mediaInfo.title;
	var murl = this.mediaInfo.urlAddress;

  var intent = wae.create("Intent");

  //intent.startPlayerWithPackageName(murl, "com.meson.videoplayer");
  intent.startPlayerWithPackageName(murl, "com.vatata.player");

  //intent.createIntentByPackageName("com.meson.videoplayer");
  //intent.setDataAndType(murl, "video/*");
  //intent.startActivity();
}

mediaItem.pay = function() {
  var res = confirm( TR("Do you sure to pay?") );
  if ( ! res ) {
    return;
  }

  if ( ! deviceInfo || ! deviceInfo.info || ! deviceInfo.info.contacts ) {
    alert("Fatal: no device info!");
    return;
  }
  
  messagestr = "Price: " + this.mediaInfo.score 
          + " , Movie: " + this.mediaInfo.title
          + " , MovieId: " + this.mediaInfo.autoid ;


  try {
    var serverurl = waeparams.getContentProviderPersistence("mainhosturl");
    var pushurl = serverurl + 'index.php/photo/api?action=setimgs&photo_id={RID}&name={NAME}&roomNo={ROOM}&about={MSG}&other_info={OTHER}';

    var pushfunc = function( rid, name, room, msg, other ) {
      var url = pushurl.replace("{RID}" , rid)
            .replace("{NAME}", encodeURIComponent(name) )
            .replace("{ROOM}", encodeURIComponent(room) )
            .replace("{MSG}",  encodeURIComponent(msg)  )
            .replace("{OTHER}", encodeURIComponent(other) );
      var uget = new EasyGet();
      uget.onsuccess = function(u,d) {}
      uget.open( url, true );
    }

    pushfunc( 925, "Movie Pay", deviceInfo.info.contacts, messagestr , "" )

    var k = "pay_" + this.mediaInfo.autoid;
    localStorage.setItem( k ,  (new Date()).getTime() );

    document.getElementById("previewBtn").style.display = "none";
    document.getElementById("payBtn").style.display = "none";
    document.getElementById("payPlayBtn").style.display = "";

    VatataKeyMove.initDefault();

  }catch(e){
    alert("Fatal Error!");
  }     

}

mediaItem.playWithAD = function() {
  var adurl = adInfo.getOneAdUrl();

  var intent = wae.create("Intent");
  intent.onClose = function() {
    mediaItem.play();
  }
  intent.startPlayerWithPackageName(adurl, "com.vatata.player");
}

mediaItem.load( Request.q("mid",""));

sessionStorage.setItem('cate_id', Request.q("cid","") );

//history.pushState( "info", "movie info", "info.html"); 
//alert("push state");
</script>



